name: FormalCert Probability System - CI/CD

# 更简单的触发条件
on:
  push:
    branches: [ main, develop, master ]  # 添加 master 分支
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: 构建与测试
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取完整历史
    
    - name: 显示触发信息
      run: |
        echo "=== 工作流触发信息 ==="
        echo "触发事件: ${{ github.event_name }}"
        echo "分支: ${{ github.ref }}"
        echo "提交: ${{ github.sha }}"
        echo "仓库: ${{ github.repository }}"
        echo "工作流: ${{ github.workflow }}"
        
        echo "=== 文件更改 ==="
        if [ "${{ github.event_name }}" = "push" ]; then
          echo "推送事件，显示最新提交信息:"
          git log --oneline -1
        elif [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "拉取请求事件:"
          echo "PR 编号: ${{ github.event.pull_request.number }}"
        fi
        
        echo "=== 当前文件结构 ==="
        find . -type f -name "*.v" -o -name "*.txt" -o -name "*.yml" -o -name "*.yaml" | head -20
    
    - name: 设置环境变量
      run: |
        # 转换仓库名为小写，避免 Docker 镜像名大小写问题
        REPO_NAME_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
        echo "REPO_NAME_LOWER=$REPO_NAME_LOWER" >> $GITHUB_ENV
        echo "IMAGE_TAG=formalcert-coq-${{ github.run_number }}" >> $GITHUB_ENV
    
    - name: 检查必要文件
      run: |
        echo "检查 Dockerfile..."
        if [ -f "Dockerfile" ]; then
          echo "✓ Dockerfile 存在"
        else
          echo "创建默认 Dockerfile..."
          cat > Dockerfile << 'EOF'
FROM coqorg/coq:8.16

RUN apt-get update && apt-get install -y \
    git make time \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /workspace
CMD ["/bin/bash"]
EOF
        fi
        
        echo "检查 Coq 文件..."
        if [ -f "上.txt" ]; then
          echo "✓ 找到 上.txt，准备处理"
          mkdir -p src
          cp 上.txt src/FormalCert_Probability_System.v
          echo "已复制到 src/FormalCert_Probability_System.v"
        elif [ -f "src/FormalCert_Probability_System.v" ]; then
          echo "✓ 找到 Coq 源文件"
        else
          echo "⚠️ 未找到 Coq 源文件，但工作流将继续"
        fi
    
    - name: 设置 Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: 登录到 GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: 构建 Docker 镜像
      run: |
        echo "构建 Docker 镜像..."
        echo "镜像标签: $IMAGE_TAG"
        echo "注册表镜像: ghcr.io/$REPO_NAME_LOWER/coq-ci:${{ github.sha }}"
        
        # 使用更简单的构建命令
        docker build -t $IMAGE_TAG .
        
        # 标记并推送
        docker tag $IMAGE_TAG ghcr.io/$REPO_NAME_LOWER/coq-ci:${{ github.sha }}
        docker tag $IMAGE_TAG ghcr.io/$REPO_NAME_LOWER/coq-ci:latest
        
        docker push ghcr.io/$REPO_NAME_LOWER/coq-ci:${{ github.sha }}
        docker push ghcr.io/$REPO_NAME_LOWER/coq-ci:latest
    
    - name: 编译 Coq 文件
      run: |
        if [ -f "src/FormalCert_Probability_System.v" ]; then
          echo "编译 Coq 文件..."
          docker run --rm \
            -v $(pwd):/workspace \
            -w /workspace \
            $IMAGE_TAG \
            bash -c "
              cd src && \
              echo 'Coq 版本:' && \
              coqc --version && \
              echo '开始编译...' && \
              coqc -q FormalCert_Probability_System.v && \
              echo '✓ 编译成功' && \
              ls -la *.vo *.glob
            "
        else
          echo "⚠️ 跳过编译：未找到 Coq 源文件"
        fi
    
    - name: 生成报告
      if: always()
      run: |
        echo "生成构建报告..."
        
        cat > build-report.md << 'EOF'
        # 构建报告
        
        ## 基本信息
        - 状态: ${{ job.status }}
        - 时间: $(date)
        - 运行: ${{ github.run_number }}
        
        ## 文件状态
        EOF
        
        if [ -f "src/FormalCert_Probability_System.v" ]; then
          echo "- Coq 文件: 存在" >> build-report.md
          echo "- 行数: $(wc -l < src/FormalCert_Probability_System.v)" >> build-report.md
        else
          echo "- Coq 文件: 不存在" >> build-report.md
        fi
        
        cat build-report.md
    
    - name: 上传报告
      uses: actions/upload-artifact@v4
      with:
        name: build-report
        path: build-report.md