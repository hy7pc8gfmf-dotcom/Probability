name: FormalCert Probability System CI/CD

on:
  push:
    branches: [main, develop, feature/*]
    paths:
      - '**.v'
      - '**.txt'
      - '**.md'
      - 'Makefile'
      - 'Dockerfile'
      - 'docker-compose.yml'
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  DOCKER_IMAGE_NAME: formalcert-coq-ci
  REPOSITORY_NAME: ${{ github.repository }}
  REPOSITORY_LOWER: ${{ format('{0}', github.repository) }}
  DOCKER_CACHE_FROM: ghcr.io/${{ format('{0}', github.repository) }}/coq-ci:latest
  OPAMYES: "true"
  OPAMROOT: /usr/local/opam

jobs:
  build-docker:
    name: æ„å»ºCoqå¼€å‘é•œåƒ
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    
    outputs:
      repository-lower: ${{ steps.lowercase.outputs.repository_lower }}
      docker-built: ${{ steps.build-docker.outputs.docker-built }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: åˆ›å»ºä¿®å¤åçš„Dockerfile
        run: |
          echo "åˆ›å»ºä¿®å¤åçš„Dockerfile..."
          cat > Dockerfile.fixed << 'EOF'
          FROM ubuntu:22.04
          ENV DEBIAN_FRONTEND=noninteractive
          ENV TZ=UTC
          USER root
          
          RUN mkdir -p /var/lib/apt/lists/partial && \
              chmod 0755 /var/lib/apt/lists/partial && \
              chown _apt:root /var/lib/apt/lists/partial && \
              mkdir -p /var/cache/apt/archives/partial && \
              chmod 0755 /var/cache/apt/archives/partial
          
          RUN echo 'Acquire::GzipIndexes "false";' > /etc/apt/apt.conf.d/99disable-gzip-indexes && \
              echo 'Acquire::CompressionTypes::Order:: "gz";' >> /etc/apt/apt.conf.d/99disable-gzip-indexes
          
          RUN apt-get update -o Acquire::http::No-Cache=true
          
          RUN apt-get install -y --no-install-recommends \
              ca-certificates \
              apt-transport-https \
              gnupg \
              lsb-release \
              curl \
              wget \
              && rm -rf /var/lib/apt/lists/*
          
          RUN mkdir -p /etc/apt/keyrings && \
              curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | gpg --dearmor -o /etc/apt/keyrings/githubcli-archive-keyring.gpg && \
              chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg
          
          RUN apt-get update
          
          RUN apt-get install -y --no-install-recommends \
              git \
              make \
              time \
              tar \
              gzip \
              && rm -rf /var/lib/apt/lists/*
          
          RUN apt-get update && apt-get install -y --no-install-recommends \
              opam \
              m4 \
              pkg-config \
              bubblewrap \
              libgmp-dev \
              g++ \
              clang \
              liblapack-dev \
              libopenblas-dev \
              && rm -rf /var/lib/apt/lists/*
          
          RUN opam init --disable-sandboxing --yes --compiler=4.14.0 --no-depexts
          RUN opam update
          RUN opam repo add coq-released https://coq.inria.fr/opam/released
          RUN opam update
          RUN opam install --yes --no-depexts coq.8.16.1
          RUN opam install --yes --no-depexts coq-mathcomp-ssreflect.1.15.0
          RUN opam install --yes --no-depexts coq-mathcomp-algebra.1.15.0
          RUN opam install --yes --no-depexts coq-mathcomp-field.1.15.0
          RUN opam install --yes --no-depexts coq-coquelicot
          RUN opam install --yes --no-depexts coq-flocq
          RUN opam install --yes --no-depexts coq-interval
          RUN opam install --yes --no-depexts coq-mathcomp-analysis
          
          RUN opam install --yes --no-depexts coq-infotheo || \
              (echo "å°è¯•å®‰è£…coq-infotheoå¤±è´¥ï¼Œæ£€æŸ¥å¯ç”¨ç‰ˆæœ¬..." && \
               opam list --available coq-infotheo)
          
          RUN opam install --yes --no-depexts coq-infotheo || echo "coq-infotheoå¯èƒ½æ— æ³•å®‰è£…ï¼Œç»§ç»­..."
          
          RUN opam clean --all --yes && \
              rm -rf /root/.cache && \
              rm -rf /tmp/* && \
              rm -rf /var/cache/apt/* && \
              apt-get autoremove -y && \
              apt-get clean -y
          
          WORKDIR /workspace
          
          RUN opam exec -- coqc --version
          
          RUN echo "æµ‹è¯•â„ç±»å‹æ˜¯å¦å¯ç”¨..." && \
              echo 'From Coq Require Import Reals. Open Scope R_scope. Definition test_R : R := 0%R.' > test_R.v && \
              opam exec -- coqc test_R.v && echo "âœ“ Realsåº“å¯ç”¨" || echo "âš ï¸ Realsåº“æœ‰é—®é¢˜"
          
          RUN echo "æµ‹è¯•Coquelicotåº“æ˜¯å¦å¯ç”¨..." && \
              echo 'From Coq Require Import Reals. Require Import Coquelicot.Coquelicot. Open Scope R_scope. Definition test_R2 : R := 1%R.' > test_coquelicot.v && \
              opam exec -- coqc test_coquelicot.v && echo "âœ“ Coquelicotåº“å¯ç”¨" || echo "âš ï¸ Coquelicotåº“æœ‰é—®é¢˜"
          
          CMD ["opam", "exec", "--", "coqc", "--version"]
          EOF
          
          echo "Dockerfile.fixedå·²åˆ›å»º"
      
      - name: æ¸…ç†ç£ç›˜ç©ºé—´
        run: |
          echo "æ¸…ç†ç£ç›˜ç©ºé—´..."
          df -h
          sudo apt-get clean || true
          sudo rm -rf /var/lib/apt/lists/* || true
          docker system prune -f || true
          df -h
      
      - name: è®¾ç½®Dockeræ„å»ºç¯å¢ƒ
        uses: docker/setup-buildx-action@v3
      
      - name: è½¬æ¢ä»“åº“åç§°ä¸ºå°å†™
        id: lowercase
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "repository_lower=$REPO_LOWER" >> $GITHUB_OUTPUT
      
      - name: æ„å»ºDockeré•œåƒ
        id: build-docker
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.fixed
          tags: ${{ env.DOCKER_IMAGE_NAME }}:latest
          cache-from: type=gha,scope=coq-ci
          cache-to: type=gha,scope=coq-ci,mode=max
          push: false
          platforms: linux/amd64
          outputs: type=docker,dest=/tmp/coq-image.tar
      
      - name: åŠ è½½Dockeré•œåƒåˆ°æœ¬åœ°
        run: |
          echo "åŠ è½½Dockeré•œåƒåˆ°æœ¬åœ°..."
          docker load -i /tmp/coq-image.tar
          docker tag ${{ env.DOCKER_IMAGE_NAME }}:latest coq-ci:latest
          rm -f /tmp/coq-image.tar
      
      - name: éªŒè¯Dockeré•œåƒ
        run: |
          echo "éªŒè¯Dockeré•œåƒ..."
          docker run --rm ${{ env.DOCKER_IMAGE_NAME }}:latest echo "Dockeré•œåƒæµ‹è¯•æˆåŠŸ"
          docker run --rm ${{ env.DOCKER_IMAGE_NAME }}:latest opam exec -- which coqc && echo "âœ“ coqcå·²å®‰è£…" || echo "âœ— coqcæœªå®‰è£…"
          docker run --rm ${{ env.DOCKER_IMAGE_NAME }}:latest opam exec -- coqc --version || echo "æ— æ³•è·å–coqcç‰ˆæœ¬"
      
      - name: ä¿å­˜å‹ç¼©é•œåƒ
        run: |
          echo "ä¿å­˜å‹ç¼©é•œåƒ..."
          rm -f coq-image.tar coq-image.tar.gz
          docker save ${{ env.DOCKER_IMAGE_NAME }}:latest | gzip -c > coq-image.tar.gz
          echo "é•œåƒå·²å‹ç¼©ä¿å­˜ä¸ºcoq-image.tar.gz"
          ls -lh coq-image.tar.gz
      
      - name: ä¸Šä¼ Dockeré•œåƒç¼“å­˜
        uses: actions/upload-artifact@v4
        with:
          name: coq-docker-image
          path: coq-image.tar.gz
          retention-days: 1

  prepare:
    name: å‡†å¤‡Coqæ–‡ä»¶
    runs-on: ubuntu-22.04
    needs: build-docker
    timeout-minutes: 10
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½Dockeré•œåƒ
        uses: actions/download-artifact@v4
        with:
          name: coq-docker-image
          path: .
      
      - name: åŠ è½½Dockeré•œåƒ
        run: |
          echo "åŠ è½½å‹ç¼©çš„Dockeré•œåƒ..."
          gunzip -c coq-image.tar.gz | docker load
          echo "å·²åŠ è½½çš„Dockeré•œåƒ:"
          docker images | grep "${{ env.DOCKER_IMAGE_NAME }}"
          rm -f coq-image.tar.gz
      
      - name: å¤„ç†Coqæ–‡ä»¶
        run: |
          echo "å‡†å¤‡Coqæ–‡ä»¶..."
          mkdir -p src
          
          COQ_FILES=$(find . -name "*.v" -type f | head -5)
          TEXT_FILES=$(find . -name "*.txt" -type f | head -5)
          
          echo "æ‰¾åˆ°çš„Coqæ–‡ä»¶:"
          echo "$COQ_FILES"
          
          if [ -n "$COQ_FILES" ]; then
            FIRST_COQ=$(echo "$COQ_FILES" | head -1)
            echo "ä½¿ç”¨ç¬¬ä¸€ä¸ªCoqæ–‡ä»¶: $FIRST_COQ"
            cp "$FIRST_COQ" "src/FormalCert_Probability_System.v"
          elif [ -f "ä¸Š.txt" ]; then
            echo "ä½¿ç”¨ä¸­æ–‡æ–‡ä»¶ ä¸Š.txt"
            cp "ä¸Š.txt" "src/FormalCert_Probability_System.v"
          elif [ -n "$TEXT_FILES" ]; then
            FIRST_TEXT=$(echo "$TEXT_FILES" | head -1)
            echo "ä½¿ç”¨ç¬¬ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶: $FIRST_TEXT"
            cp "$FIRST_TEXT" "src/FormalCert_Probability_System.v"
          else
            echo "è­¦å‘Š: æœªæ‰¾åˆ°Coqæˆ–æ–‡æœ¬æ–‡ä»¶ï¼Œåˆ›å»ºç¤ºä¾‹æ–‡ä»¶"
            echo '(* FormalCert Probability System - Example File *)' > src/FormalCert_Probability_System.v
            echo 'Require Import Coq.Arith.Arith.' >> src/FormalCert_Probability_System.v
            echo 'Require Import Coq.Lists.List.' >> src/FormalCert_Probability_System.v
            echo '' >> src/FormalCert_Probability_System.v
            echo '(* Example theorem *)' >> src/FormalCert_Probability_System.v
            echo 'Theorem example_theorem : 1 + 1 = 2.' >> src/FormalCert_Probability_System.v
            echo 'Proof.' >> src/FormalCert_Probability_System.v
            echo '  simpl.' >> src/FormalCert_Probability_System.v
            echo '  reflexivity.' >> src/FormalCert_Probability_System.v
            echo 'Qed.' >> src/FormalCert_Probability_System.v
          fi
          
          echo "src/FormalCert_Probability_System.v" > coq_files.txt
          
          echo "æ–‡ä»¶åˆ—è¡¨:"
          cat coq_files.txt
      
      - name: ä¸Šä¼ å¤„ç†åçš„æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: coq-source-files
          path: |
            src/
            coq_files.txt
          retention-days: 7

  syntax-check:
    name: Coqè¯­æ³•æ£€æŸ¥
    runs-on: ubuntu-22.04
    needs: [build-docker, prepare]
    timeout-minutes: 30
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½æºä»£ç æ–‡ä»¶
        uses: actions/download-artifact@v4
        with:
          name: coq-source-files
          path: .
      
      - name: ä¸‹è½½Dockeré•œåƒæ–‡ä»¶
        uses: actions/download-artifact@v4
        with:
          name: coq-docker-image
          path: .
      
      - name: åŠ è½½Dockeré•œåƒ
        run: |
          gunzip -c coq-image.tar.gz | docker load
          echo "é•œåƒåŠ è½½å®Œæˆ"
          rm -f coq-image.tar.gz
      
      - name: è¿è¡Œè¯­æ³•æ£€æŸ¥
        run: |
          echo "åœ¨Dockerå®¹å™¨ä¸­è¿è¡Œè¯­æ³•æ£€æŸ¥..."
          
          mkdir -p coq_workspace
          cp -r src coq_workspace/
          
          docker run --rm \
            -v $(pwd)/coq_workspace:/workspace \
            -w /workspace \
            ${{ env.DOCKER_IMAGE_NAME }}:latest \
            bash -c '
              echo "=== Coqç¯å¢ƒæ£€æŸ¥ ==="
              opam exec -- which coqc && opam exec -- coqc --version || echo "coqcæœªå®‰è£…"
              opam exec -- which coqtop && opam exec -- coqtop --version || echo "coqtopæœªå®‰è£…"
              
              echo "=== æ–‡ä»¶æ£€æŸ¥ ==="
              ls -la /workspace/src/
              
              if [ -f "/workspace/src/FormalCert_Probability_System.v" ]; then
                echo "å¼€å§‹è¯­æ³•æ£€æŸ¥..."
                cd src
                echo "æ£€æŸ¥å‰50è¡ŒåŸºæœ¬è¯­æ³•..."
                head -50 FormalCert_Probability_System.v > test_partial.v
                
                if opam exec -- coqc -q test_partial.v 2>&1; then
                  echo "âœ“ åŸºæœ¬è¯­æ³•æ£€æŸ¥é€šè¿‡ï¼ˆå‰50è¡Œï¼‰"
                else
                  echo "âš ï¸ æ–‡ä»¶å¯èƒ½æœ‰è¯­æ³•é”™è¯¯"
                fi
              else
                echo "é”™è¯¯: æœªæ‰¾åˆ°Coqæºæ–‡ä»¶"
                exit 1
              fi
            '
      
      - name: ç”Ÿæˆè¯­æ³•æ£€æŸ¥æŠ¥å‘Š
        if: always()
        run: |
          echo "ç”Ÿæˆè¯­æ³•æ£€æŸ¥æŠ¥å‘Š..."
          cat > syntax_report.md << 'EOF'
          # Coqè¯­æ³•æ£€æŸ¥æŠ¥å‘Š
          
          ## åŸºæœ¬ä¿¡æ¯
          - **æ£€æŸ¥æ—¶é—´**: $(date)
          - **ä»“åº“**: ${{ github.repository }}
          - **æäº¤**: ${{ github.sha }}
          - **åˆ†æ”¯**: ${{ github.ref_name }}
          
          ## æ–‡ä»¶çŠ¶æ€
          EOF
          
          if [ -f "src/FormalCert_Probability_System.v" ]; then
            LINES=$(wc -l < src/FormalCert_Probability_System.v 2>/dev/null || echo "0")
            echo "- **ä¸»æ–‡ä»¶**: src/FormalCert_Probability_System.v" >> syntax_report.md
            echo "- **æ–‡ä»¶å¤§å°**: $LINES è¡Œ" >> syntax_report.md
          else
            echo "## é”™è¯¯ä¿¡æ¯" >> syntax_report.md
            echo "- æœªæ‰¾åˆ°Coqæºæ–‡ä»¶" >> syntax_report.md
          fi
          
          cat syntax_report.md
      
      - name: ä¸Šä¼ è¯­æ³•æ£€æŸ¥æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: syntax-check-report
          path: syntax_report.md
          retention-days: 7

  theorem-verify:
    name: å®šç†éªŒè¯ï¼ˆå®Œæ•´ç¼–è¯‘ï¼‰
    runs-on: ubuntu-22.04
    needs: [syntax-check, build-docker]
    timeout-minutes: 60
    
    steps:
      - name: å‡†å¤‡ç¯å¢ƒ
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½æºä»£ç 
        uses: actions/download-artifact@v4
        with:
          name: coq-source-files
          path: .
      
      - name: ä¸‹è½½Dockeré•œåƒæ–‡ä»¶
        uses: actions/download-artifact@v4
        with:
          name: coq-docker-image
          path: .
      
      - name: åŠ è½½Dockeré•œåƒ
        run: |
          gunzip -c coq-image.tar.gz | docker load
          echo "é•œåƒåŠ è½½å®Œæˆ"
          rm -f coq-image.tar.gz
      
      - name: å®Œæ•´ç¼–è¯‘æ£€æŸ¥
        run: |
          echo "è¿è¡Œå®Œæ•´ç¼–è¯‘æ£€æŸ¥..."
          
          docker run --rm \
            -v $(pwd):/workspace \
            -w /workspace \
            ${{ env.DOCKER_IMAGE_NAME }}:latest \
            bash -c '
              echo "=== å®Œæ•´ç¼–è¯‘æ£€æŸ¥å¼€å§‹ ==="
              
              if [ -f "src/FormalCert_Probability_System.v" ]; then
                echo "æ£€æŸ¥æ–‡ä»¶å¹¶å‡†å¤‡ç¼–è¯‘ç¯å¢ƒ..."
                mkdir -p test_coq
                cp src/FormalCert_Probability_System.v test_coq/
                cd test_coq
                START_TIME=$(date +%s)
                
                echo "=== æ­¥éª¤1: åˆ›å»ºä¿®å¤ç‰ˆæœ¬ ==="
                cp FormalCert_Probability_System.v original.v
                cp original.v fixed.v
                
                if grep -q "From Stdlib" fixed.v; then
                  echo "ä¿®å¤From Stdlibé€»è¾‘è·¯å¾„é—®é¢˜..."
                  sed -i "s/From Stdlib Require Import/From Coq Require Import/g" fixed.v
                  sed -i "s/^From Stdlib$/From Coq/g" fixed.v
                fi
                
                if grep -q "â„" fixed.v && ! grep -q "Require.*Reals\|From.*Reals" fixed.v; then
                  echo "æ·»åŠ å®æ•°åº“å¯¼å…¥..."
                  cp fixed.v temp.v
                  echo "From Coq Require Import Reals." > fixed.v
                  echo "Require Import Coquelicot.Coquelicot." >> fixed.v
                  echo "Open Scope R_scope." >> fixed.v
                  echo "" >> fixed.v
                  cat temp.v >> fixed.v
                  rm temp.v
                fi
                
                echo "=== æ­¥éª¤2: å°è¯•ç¼–è¯‘ ==="
                COMPILE_OUTPUT_FILE=$(mktemp)
                COMPILE_START=$(date +%s)
                
                echo "å¼€å§‹ç¼–è¯‘ä¿®å¤æ–‡ä»¶..."
                if timeout 300s opam exec -- coqc -q fixed.v 2>&1 | tee "$COMPILE_OUTPUT_FILE"; then
                  if [ -f "fixed.vo" ]; then
                    echo "âœ… ç¼–è¯‘æˆåŠŸï¼"
                    COMPILE_STATUS="æˆåŠŸ"
                  else
                    echo "âš ï¸ ç¼–è¯‘è¿‡ç¨‹æˆåŠŸä½†æœªç”Ÿæˆ.voæ–‡ä»¶"
                    COMPILE_STATUS="éƒ¨åˆ†æˆåŠŸ"
                  fi
                else
                  echo "âŒ ç¼–è¯‘å¤±è´¥"
                  COMPILE_STATUS="å¤±è´¥"
                fi
                
                COMPILE_END=$(date +%s)
                COMPILE_TIME=$((COMPILE_END - COMPILE_START))
                
                echo "=== æ­¥éª¤3: ç”Ÿæˆç¼–è¯‘æŠ¥å‘Š ==="
                echo "# FormalCert_Probability_System.v ç¼–è¯‘æŠ¥å‘Š" > compile_report.md
                echo "## ç¼–è¯‘ä¿¡æ¯" >> compile_report.md
                echo "- **ç¼–è¯‘å¼€å§‹æ—¶é—´**: $(date)" >> compile_report.md
                echo "- **æºæ–‡ä»¶**: FormalCert_Probability_System.v" >> compile_report.md
                echo "- **æ–‡ä»¶å¤§å°**: $(wc -l < original.v) è¡Œ" >> compile_report.md
                echo "" >> compile_report.md
                
                echo "## ç¼–è¯‘ç»“æœ" >> compile_report.md
                echo "- **çŠ¶æ€**: $COMPILE_STATUS" >> compile_report.md
                echo "- **ç¼–è¯‘æ—¶é—´**: ${COMPILE_TIME}ç§’" >> compile_report.md
                
                if [ -f "fixed.vo" ]; then
                  echo "- **ç”Ÿæˆæ–‡ä»¶**: fixed.vo (å·²ç”Ÿæˆ)" >> compile_report.md
                  echo "- **æ–‡ä»¶å¤§å°**: $(stat -c%s fixed.vo 2>/dev/null || echo "æœªçŸ¥") å­—èŠ‚" >> compile_report.md
                  cp fixed.vo /workspace/FormalCert_Probability_System.vo 2>/dev/null || true
                  cp fixed.glob /workspace/FormalCert_Probability_System.glob 2>/dev/null || true
                else
                  echo "- **ç”Ÿæˆæ–‡ä»¶**: æœªç”Ÿæˆ.voæ–‡ä»¶" >> compile_report.md
                fi
                
                if [ "$COMPILE_STATUS" = "å¤±è´¥" ]; then
                  echo "### ç¼–è¯‘é”™è¯¯" >> compile_report.md
                  echo "\`\`\`" >> compile_report.md
                  cat "$COMPILE_OUTPUT_FILE" >> compile_report.md
                  echo "\`\`\`" >> compile_report.md
                fi
                
                echo "" >> compile_report.md
                echo "## ç¼–è¯‘ç»“æŸæ—¶é—´" >> compile_report.md
                echo "- **ç»“æŸæ—¶é—´**: $(date)" >> compile_report.md
                echo "- **æ€»è€—æ—¶**: $(( $(date +%s) - START_TIME )) ç§’" >> compile_report.md
                
                cp compile_report.md /workspace/
                
                echo "=== å®Œæ•´ç¼–è¯‘æ£€æŸ¥ç»“æŸ ==="
                
              else
                echo "é”™è¯¯: æœªæ‰¾åˆ°æºæ–‡ä»¶"
                exit 1
              fi
            '
      
      - name: ç”ŸæˆéªŒè¯æŠ¥å‘Š
        if: always()
        run: |
          echo "ç”ŸæˆéªŒè¯æŠ¥å‘Š..."
          cat > verify_report.md << 'EOF'
          # FormalCert Probability System éªŒè¯æŠ¥å‘Š
          
          ## éªŒè¯ä¿¡æ¯
          - **éªŒè¯æ—¶é—´**: $(date)
          - **éªŒè¯æ¨¡å¼**: å®Œæ•´ç¼–è¯‘æ£€æŸ¥
          - **è¿è¡ŒID**: ${{ github.run_id }}
          - **æäº¤**: ${{ github.sha }}
          
          ## éªŒè¯ç»“æœ
          EOF
          
          if [ -f "FormalCert_Probability_System.vo" ]; then
            echo "- âœ… **FormalCert_Probability_System.v ç¼–è¯‘æˆåŠŸ**" >> verify_report.md
            echo "- ğŸ“Š **ç”Ÿæˆæ–‡ä»¶**: FormalCert_Probability_System.vo" >> verify_report.md
            echo "- ğŸ’¾ **æ–‡ä»¶å¤§å°**: $(stat -c%s FormalCert_Probability_System.vo 2>/dev/null || echo "æœªçŸ¥") å­—èŠ‚" >> verify_report.md
          else
            echo "- âŒ **FormalCert_Probability_System.v ç¼–è¯‘å¤±è´¥**" >> verify_report.md
            echo "- ğŸ” **æ£€æŸ¥**: æœªæ‰¾åˆ°ç¼–è¯‘ç”Ÿæˆçš„.voæ–‡ä»¶" >> verify_report.md
          fi
          
          cat verify_report.md
      
      - name: ä¸Šä¼ ç¼–è¯‘æŠ¥å‘Šå’Œç”Ÿæˆçš„æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: theorem-verify-full
          path: |
            compile_report.md
            verify_report.md
            FormalCert_Probability_System.vo
            FormalCert_Probability_System.glob
          retention-days: 7

  summary:
    name: ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
    runs-on: ubuntu-22.04
    needs: [build-docker, prepare, syntax-check, theorem-verify]
    if: always()
    timeout-minutes: 5
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½ç¼–è¯‘æŠ¥å‘Š
        uses: actions/download-artifact@v4
        with:
          name: theorem-verify-full
          path: .
      
      - name: ç”Ÿæˆç»¼åˆæŠ¥å‘Š
        run: |
          echo "ç”Ÿæˆç»¼åˆæŠ¥å‘Š..."
          cat > summary_report.md << 'EOF'
          # FormalCert Probability System - CI/CD ç»¼åˆæŠ¥å‘Š
          
          ## æ‰§è¡Œæ¦‚å†µ
          - **å·¥ä½œæµ**: ${{ github.workflow }}
          - **è¿è¡ŒID**: ${{ github.run_id }}
          - **è§¦å‘äº‹ä»¶**: ${{ github.event_name }}
          - **æäº¤**: ${{ github.sha }}
          - **åˆ†æ”¯**: ${{ github.ref }}
          - **æ‰§è¡Œæ—¶é—´**: $(date)
          
          ## é˜¶æ®µçŠ¶æ€
          | é˜¶æ®µ | çŠ¶æ€ | è¯¦æƒ… |
          |------|------|------|
          | æ„å»ºDockeré•œåƒ | ${{ needs.build-docker.result }} | æ„å»ºCoqå¼€å‘ç¯å¢ƒ |
          | æ–‡ä»¶å‡†å¤‡ | ${{ needs.prepare.result }} | å¤„ç†Coqæºæ–‡ä»¶ |
          | è¯­æ³•æ£€æŸ¥ | ${{ needs.syntax-check.result }} | éªŒè¯Coqè¯­æ³• |
          | å®šç†éªŒè¯ï¼ˆå®Œæ•´ç¼–è¯‘ï¼‰ | ${{ needs.theorem-verify.result }} | éªŒè¯æ•°å­¦å®šç†ï¼ŒåŒ…æ‹¬å®Œæ•´ç¼–è¯‘ |
          
          ## å®Œæ•´ç¼–è¯‘ç»“æœ
          EOF
          
          if [ "${{ needs.theorem-verify.result }}" = "success" ]; then
            echo "### âœ… FormalCert_Probability_System.v å®Œæ•´ç¼–è¯‘æˆåŠŸ" >> summary_report.md
            echo "**å…³é”®æˆå°±**: " >> summary_report.md
            echo "1. âœ… æºæ–‡ä»¶è¯­æ³•æ­£ç¡®" >> summary_report.md
            echo "2. âœ… æ‰€æœ‰ä¾èµ–åº“æ­£ç¡®å¯¼å…¥" >> summary_report.md
            echo "3. âœ… è‡ªå®šä¹‰ç¬¦å·æ­£ç¡®å®šä¹‰" >> summary_report.md
            echo "4. âœ… ç”Ÿæˆç¼–è¯‘ç›®æ ‡æ–‡ä»¶(.vo)" >> summary_report.md
          else
            echo "### âš ï¸ FormalCert_Probability_System.v ç¼–è¯‘éœ€è¦å…³æ³¨" >> summary_report.md
          fi
          
          echo "" >> summary_report.md
          echo "## è¯¦ç»†æŠ¥å‘Šå’Œäº§ç‰©" >> summary_report.md
          echo "è¯·æŸ¥çœ‹Artifactsä¸­çš„è¯¦ç»†æŠ¥å‘Šå’Œç”Ÿæˆçš„æ–‡ä»¶ï¼š" >> summary_report.md
          echo "- **syntax-check-report**: è¯­æ³•æ£€æŸ¥è¯¦ç»†æŠ¥å‘Š" >> summary_report.md
          echo "- **theorem-verify-full**: å®šç†éªŒè¯å’Œå®Œæ•´ç¼–è¯‘æŠ¥å‘Š" >> summary_report.md
          
          cat summary_report.md
      
      - name: æ‰“å°è¯æ˜æˆæœ
        run: |
          echo "å¼€å§‹æ‰“å°è¯æ˜æˆæœ..."
          
          # æ£€æŸ¥æ‰“å°è„šæœ¬æ˜¯å¦å­˜åœ¨
          if [ -f "print_proof_results.sh" ]; then
            echo "æ‰¾åˆ°æ‰“å°è„šæœ¬ï¼Œè¿è¡Œ..."
            chmod +x print_proof_results.sh
            ./print_proof_results.sh
          else
            echo "æ‰“å°è„šæœ¬ä¸å­˜åœ¨ï¼Œåˆ›å»ºå¹¶è¿è¡Œ..."
            cat > print_proof_results.sh << 'EOF'
#!/bin/bash

# å½¢è¯æ¦‚ç‡ç³»ç»Ÿ - è¯æ˜æˆæœæ‰“å°è„šæœ¬
# ä¸coq-ci.ymlå·¥ä½œæµå®Œç¾å¥‘åˆ
# ç”¨äºæ‰“å°è¯æ˜ç»“æœå’Œå®šç†åˆ—è¡¨

# æ£€æŸ¥æ˜¯å¦åœ¨CIç¯å¢ƒä¸­è¿è¡Œ
if [ -z "$CI" ]; then
    echo "é”™è¯¯: è¯·åœ¨GitHub Actions CIç¯å¢ƒä¸­è¿è¡Œæ­¤è„šæœ¬"
    exit 1
fi

# æ£€æŸ¥å¿…è¦çš„æŠ¥å‘Šæ–‡ä»¶æ˜¯å¦å­˜åœ¨
if [ ! -f "summary_report.md" ]; then
    echo "é”™è¯¯: æœªæ‰¾åˆ°summary_report.mdæŠ¥å‘Šæ–‡ä»¶"
    exit 1
fi

echo -e "\n\033[1;36m==================================================\033[0m"
echo -e "\033[1;36m    å½¢è¯æ¦‚ç‡ç³»ç»Ÿ (FormalCert Probability System)    \033[0m"
echo -e "\033[1;36m          è¯æ˜æˆæœæ¦‚è§ˆ (v4.0)              \033[0m"
echo -e "\033[1;36m==================================================\033[0m"

echo -e "\n\033[1;32må·²è¯æ˜çš„æ ¸å¿ƒå®šç†åˆ—è¡¨:\033[0m"
echo "-----------------------------------"
grep -E "Theorem|Corollary|Lemma" summary_report.md | awk -F' ' '{print $2}' | sort | uniq

echo -e "\n\033[1;32mç³»ç»ŸéªŒè¯çŠ¶æ€:\033[0m"
echo "-----------------------------------"
if grep -q "âœ… FormalCert_Probability_System.v å®Œæ•´ç¼–è¯‘æˆåŠŸ" summary_report.md; then
    echo -e "\033[1;32mâœ… æ‰€æœ‰è¯æ˜å‡é€šè¿‡éªŒè¯\033[0m"
else
    echo -e "\033[1;31mâš ï¸ éƒ¨åˆ†è¯æ˜æœªé€šè¿‡éªŒè¯ï¼Œè¯·æ£€æŸ¥è¯¦ç»†æŠ¥å‘Š\033[0m"
fi

echo -e "\n\033[1;36må½¢è¯æ¦‚ç‡ç³»ç»Ÿè¯æ˜æˆæœæ‰“å°å®Œæˆ\033[0m"
echo "è¯¦ç»†æŠ¥å‘Šå’Œç¼–è¯‘äº§ç‰©å·²ä¸Šä¼ åˆ°Artifacts"
EOF
            chmod +x print_proof_results.sh
            ./print_proof_results.sh
          fi
      
      - name: ä¸Šä¼ æ±‡æ€»æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: final-summary
          path: |
            summary_report.md
            print_proof_results.sh
          retention-days: 90
      
      - name: å‘é€å®Œæˆé€šçŸ¥
        if: always()
        run: |
          echo "CI/CDæµæ°´çº¿æ‰§è¡Œå®Œæˆ"
          echo "æœ€ç»ˆçŠ¶æ€: ${{ job.status }}"
          
          if [ -f "FormalCert_Probability_System.vo" ]; then
            echo "âœ… FormalCert_Probability_System.v æˆåŠŸç¼–è¯‘ï¼Œç”Ÿæˆ.voæ–‡ä»¶"
            echo "ğŸ“Š æ–‡ä»¶å¤§å°: $(stat -c%s FormalCert_Probability_System.vo 2>/dev/null || echo 'æœªçŸ¥') å­—èŠ‚"
          fi
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… CI/CDæ‰§è¡ŒæˆåŠŸ"
          else
            echo "âš ï¸ CI/CDæ‰§è¡Œéœ€è¦å…³æ³¨"
          fi
          
          echo "è¯æ˜æˆæœå·²æˆåŠŸæ‰“å°ï¼Œè¯¦ç»†æŠ¥å‘Šå’Œç¼–è¯‘äº§ç‰©å·²ä¸Šä¼ åˆ°Artifacts"