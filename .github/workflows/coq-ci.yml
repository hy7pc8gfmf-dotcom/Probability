name: FormalCert Probability System CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**.v'
      - '**.yml'
      - 'Dockerfile'
      - 'Makefile'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  COQ_VERSION: 8.16
  DOCKER_IMAGE_NAME: formalcert-coq

jobs:
  # 阶段1: 环境检查和准备
  setup:
    name: 环境准备
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    
    - name: 检查文件结构
      run: |
        echo "=== 仓库文件结构 ==="
        ls -la
        echo ""
        echo "=== Coq文件 ==="
        find . -name "*.v" | head -10
        echo ""
        echo "=== Dockerfile ==="
        if [ -f "Dockerfile" ]; then
          echo "Dockerfile exists"
          head -20 Dockerfile
        else
          echo "ERROR: Dockerfile not found!"
          exit 1
        fi

  # 阶段2: 构建Docker镜像
  build:
    name: 构建Docker镜像
    runs-on: ubuntu-22.04
    needs: setup
    timeout-minutes: 15
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    
    - name: 设置Docker构建x
      uses: docker/setup-buildx-action@v3
    
    - name: 构建Docker镜像
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        tags: ${{ env.DOCKER_IMAGE_NAME }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        load: true  # 将镜像加载到本地Docker
    
    - name: 验证镜像
      run: |
        echo "=== 验证Docker镜像 ==="
        docker images
        docker run --rm ${{ env.DOCKER_IMAGE_NAME }}:latest coqc --version

  # 阶段3: 语法检查
  syntax-check:
    name: Coq语法检查
    runs-on: ubuntu-22.04
    needs: build
    timeout-minutes: 10
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    
    - name: 运行Coq编译
      run: |
        echo "=== 开始Coq语法检查 ==="
        
        # 查找所有Coq文件
        COQ_FILES=$(find . -name "*.v" -type f)
        
        if [ -z "$COQ_FILES" ]; then
          echo "错误: 未找到任何.v文件"
          exit 1
        fi
        
        echo "找到的Coq文件:"
        echo "$COQ_FILES"
        echo ""
        
        # 使用Docker运行Coq编译
        for file in $COQ_FILES; do
          echo "编译: $file"
          docker run --rm \
            -v $(pwd):/workspace \
            -w /workspace \
            ${{ env.DOCKER_IMAGE_NAME }}:latest \
            coqc -q "$file"
          
          if [ $? -eq 0 ]; then
            echo "✓ $file 编译成功"
          else
            echo "✗ $file 编译失败"
            exit 1
          fi
        done
        
        echo "=== 所有文件语法检查通过 ==="
    
    - name: 清理编译文件
      if: always()
      run: |
        echo "清理编译文件..."
        rm -f *.vo *.glob *.aux 2>/dev/null || true

  # 阶段4: 定理验证
  verify:
    name: 定理验证
    runs-on: ubuntu-22.04
    needs: syntax-check
    timeout-minutes: 20
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    
    - name: 验证主文件
      run: |
        echo "=== 定理验证 ==="
        
        MAIN_FILE="FormalCert_Probability_System.v"
        
        if [ ! -f "$MAIN_FILE" ]; then
          echo "错误: 未找到主文件 $MAIN_FILE"
          exit 1
        fi
        
        echo "验证文件: $MAIN_FILE"
        echo "文件大小: $(wc -l < "$MAIN_FILE") 行"
        echo ""
        
        # 运行完整编译
        docker run --rm \
          -v $(pwd):/workspace \
          -w /workspace \
          ${{ env.DOCKER_IMAGE_NAME }}:latest \
          bash -c "
            echo '=== 开始完整编译 ==='
            timeout 15m coqc -q \"$MAIN_FILE\"
            
            if [ \$? -eq 0 ]; then
              echo '✓ 完整编译成功'
              
              # 统计定理数量
              echo '=== 定理统计 ==='
              echo '定理数量:' \$(grep -c 'Theorem\|Lemma' \"$MAIN_FILE\" 2>/dev/null || echo 0)
              echo '公理数量:' \$(grep -c 'Axiom' \"$MAIN_FILE\" 2>/dev/null || echo 0)
            else
              echo '✗ 完整编译失败'
              exit 1
            fi
          "
    
    - name: 生成验证报告
      if: always()
      run: |
        echo "生成验证报告..."
        
        MAIN_FILE="FormalCert_Probability_System.v"
        
        cat > verify_report.md << EOF
        # FormalCert Probability System 验证报告
        
        ## 基本信息
        - 时间: $(date)
        - 提交: ${{ github.sha }}
        - 分支: ${{ github.ref }}
        
        ## 文件信息
        EOF
        
        if [ -f "$MAIN_FILE" ]; then
          echo "- 主文件: $MAIN_FILE" >> verify_report.md
          echo "- 行数: $(wc -l < "$MAIN_FILE")" >> verify_report.md
          echo "- 定理数量: $(grep -c "Theorem\|Lemma" "$MAIN_FILE" 2>/dev/null || echo 0)" >> verify_report.md
          echo "- 公理数量: $(grep -c "Axiom" "$MAIN_FILE" 2>/dev/null || echo 0)" >> verify_report.md
        fi
        
        echo "" >> verify_report.md
        echo "## 验证状态" >> verify_report.md
        echo "- 语法检查: ${{ needs.syntax-check.result }}" >> verify_report.md
        echo "- 定理验证: ${{ job.status }}" >> verify_report.md
        
        cat verify_report.md
    
    - name: 上传验证报告
      uses: actions/upload-artifact@v4
      with:
        name: verify-report
        path: verify_report.md
        retention-days: 7

  # 阶段5: 生成文档
  documentation:
    name: 生成文档
    runs-on: ubuntu-22.04
    needs: syntax-check
    timeout-minutes: 10
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    
    - name: 生成HTML文档
      run: |
        echo "=== 生成Coq文档 ==="
        
        MAIN_FILE="FormalCert_Probability_System.v"
        
        if [ ! -f "$MAIN_FILE" ]; then
          echo "错误: 未找到主文件 $MAIN_FILE"
          exit 1
        fi
        
        mkdir -p docs
        
        docker run --rm \
          -v $(pwd):/workspace \
          -w /workspace \
          ${{ env.DOCKER_IMAGE_NAME }}:latest \
          bash -c "
            echo '生成HTML文档...'
            coqdoc --html -d docs \"$MAIN_FILE\"
            
            echo '生成LaTeX文档...'
            coqdoc --latex -d docs \"$MAIN_FILE\" 2>/dev/null || echo 'LaTeX生成跳过'
            
            echo '文档生成完成'
            ls -la docs/
          "
    
    - name: 创建文档索引
      run: |
        echo "创建文档索引..."
        
        cat > docs/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>FormalCert Probability System</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                .header { border-bottom: 2px solid #333; padding-bottom: 20px; }
                .content { margin-top: 30px; }
                .file-list { background: #f5f5f5; padding: 15px; border-radius: 5px; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>FormalCert Probability System</h1>
                <p>Formally Verified Probability Theory in Coq</p>
            </div>
            <div class="content">
                <h2>Documentation</h2>
                <div class="file-list">
                    <ul>
        EOF
        
        # 添加HTML文件链接
        for html in docs/*.html; do
          if [ -f "$html" ]; then
            filename=$(basename "$html")
            echo "<li><a href=\"$filename\">$filename</a></li>" >> docs/index.html
          fi
        done
        
        cat >> docs/index.html << EOF
                    </ul>
                </div>
                <p><em>Generated on $(date)</em></p>
                <p>Commit: ${{ github.sha }}</p>
                <p>
                    <a href="https://github.com/${{ github.repository }}/actions/workflows/coq-ci.yml">
                        <img src="https://github.com/${{ github.repository }}/actions/workflows/coq-ci.yml/badge.svg" alt="CI Status">
                    </a>
                </p>
            </div>
        </body>
        </html>
        EOF
    
    - name: 上传文档
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: docs/
        retention-days: 30

  # 阶段6: 汇总报告
  summary:
    name: 汇总报告
    runs-on: ubuntu-22.04
    needs: [verify, documentation]
    if: always()
    
    steps:
    - name: 生成汇总报告
      run: |
        echo "生成汇总报告..."
        
        cat > summary.md << EOF
        # FormalCert Probability System CI 汇总
        
        ## 执行概况
        - 工作流: ${{ github.workflow }}
        - 运行ID: ${{ github.run_id }}
        - 触发事件: ${{ github.event_name }}
        - 提交: ${{ github.sha }}
        - 分支: ${{ github.ref }}
        - 执行时间: $(date)
        
        ## 阶段状态
        | 阶段 | 状态 |
        |------|------|
        | 环境准备 | ${{ needs.setup.result }} |
        | Docker构建 | ${{ needs.build.result }} |
        | 语法检查 | ${{ needs.syntax-check.result }} |
        | 定理验证 | ${{ needs.verify.result }} |
        | 文档生成 | ${{ needs.documentation.result }} |
        
        ## 系统信息
        - Coq版本: ${{ env.COC_VERSION }}
        - Docker镜像: ${{ env.DOCKER_IMAGE_NAME }}:latest
        - 运行环境: Ubuntu 22.04
        
        ## 后续步骤
        1. 查看验证报告了解具体验证结果
        2. 查看生成的文档
        3. 根据验证结果优化代码
        EOF
        
        cat summary.md
    
    - name: 上传汇总报告
      uses: actions/upload-artifact@v4
      with:
        name: final-summary
        path: summary.md
        retention-days: 90
    
    - name: 完成通知
      run: |
        echo "CI/CD流程执行完成"
        echo "总体状态: ${{ job.status }}"
        echo "详细报告可在Artifacts中下载"