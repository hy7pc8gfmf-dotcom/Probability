name: FormalCert Probability System CI/CD

on:
  push:
    branches: [main, develop, feature/*]
    paths:
      - '**.v'
      - '**.txt'
      - '**.md'
      - 'Makefile'
      - 'Dockerfile'
      - 'docker-compose.yml'
  pull_request:
    branches: [main]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

# è®¾ç½®å…¨å±€ç¯å¢ƒå˜é‡
env:
  DOCKER_IMAGE_NAME: formalcert-coq-ci
  REPOSITORY_NAME: ${{ github.repository }}
  REPOSITORY_LOWER: ${{ format('{0}', github.repository) }}
  DOCKER_CACHE_FROM: ghcr.io/${{ format('{0}', github.repository) }}/coq-ci:latest
  OPAMYES: "true"
  OPAMROOT: /usr/local/opam

jobs:
  # é˜¶æ®µ1: æ„å»ºDockeré•œåƒï¼ˆä¿®å¤GitHub Packagesæƒé™é—®é¢˜ï¼‰
  build-docker:
    name: æ„å»ºCoqå¼€å‘é•œåƒ
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    
    outputs:
      repository-lower: ${{ steps.lowercase.outputs.repository_lower }}
      docker-built: ${{ steps.build-docker.outputs.docker-built }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: åˆ›å»ºä¿®å¤åçš„Dockerfile
        run: |
          echo "åˆ›å»ºä¿®å¤åçš„Dockerfile..."
          
          # åˆ›å»ºä¿®å¤åçš„Dockerfile - åŒ…å«æ‰€æœ‰å¿…è¦çš„Coqåº“
          cat > Dockerfile.fixed << 'EOF'
          # ä½¿ç”¨å¸¦æœ‰å›ºå®šAPTé…ç½®çš„UbuntuåŸºç¡€é•œåƒ
          FROM ubuntu:22.04
          
          # è®¾ç½®ç¯å¢ƒå˜é‡é¿å…äº¤äº’å¼æç¤º
          ENV DEBIAN_FRONTEND=noninteractive
          ENV TZ=UTC
          
          # ä¿®å¤APTæƒé™é—®é¢˜çš„æ–¹æ³•1ï¼šä½¿ç”¨rootç”¨æˆ·å¹¶ç¡®ä¿ç›®å½•å­˜åœ¨
          USER root
          
          # åœ¨å®‰è£…ä»»ä½•åŒ…ä¹‹å‰ï¼Œç¡®ä¿APTç›®å½•å­˜åœ¨å¹¶è®¾ç½®æ­£ç¡®æƒé™
          RUN mkdir -p /var/lib/apt/lists/partial && \
              chmod 0755 /var/lib/apt/lists/partial && \
              chown _apt:root /var/lib/apt/lists/partial && \
              mkdir -p /var/cache/apt/archives/partial && \
              chmod 0755 /var/cache/apt/archives/partial
          
          # ä¿®å¤APTé…ç½®ï¼Œç¦ç”¨å‹ç¼©ç¼“å­˜
          RUN echo 'Acquire::GzipIndexes "false";' > /etc/apt/apt.conf.d/99disable-gzip-indexes && \
              echo 'Acquire::CompressionTypes::Order:: "gz";' >> /etc/apt/apt.conf.d/99disable-gzip-indexes
          
          # æ›´æ–°APTæºåˆ—è¡¨ï¼ˆä½¿ç”¨-no-downloadé€‰é¡¹é¿å…æƒé™é—®é¢˜ï¼‰
          RUN apt-get update -o Acquire::http::No-Cache=true
          
          # å®‰è£…å¿…è¦çš„ç³»ç»Ÿå·¥å…·ï¼ˆåŒ…å«curlï¼Œè¿™æ ·åé¢å°±å¯ä»¥ä½¿ç”¨äº†ï¼‰
          RUN apt-get install -y --no-install-recommends \
              ca-certificates \
              apt-transport-https \
              gnupg \
              lsb-release \
              curl \
              wget \
              && rm -rf /var/lib/apt/lists/*
          
          # ç°åœ¨curlå·²ç»å®‰è£…ï¼Œå¯ä»¥å®‰å…¨åœ°ä½¿ç”¨å®ƒæ¥æ·»åŠ GitHub GPGå¯†é’¥
          RUN mkdir -p /etc/apt/keyrings && \
              curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | gpg --dearmor -o /etc/apt/keyrings/githubcli-archive-keyring.gpg && \
              chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg
          
          # æ›´æ–°APTæº
          RUN apt-get update
          
          # å®‰è£…å¿…è¦çš„å·¥å…·
          RUN apt-get install -y --no-install-recommends \
              git \
              make \
              time \
              tar \
              gzip \
              && rm -rf /var/lib/apt/lists/*
          
          # å®‰è£…Opamå’ŒCoqæ‰€éœ€çš„ç³»ç»Ÿä¾èµ–ï¼ˆæŒ‰ç…§æ‚¨çš„æ€è·¯ï¼Œæ·»åŠ clangï¼‰
          RUN apt-get update && apt-get install -y --no-install-recommends \
              opam \
              m4 \
              pkg-config \
              bubblewrap \
              # Coqçš„GNUå¤šç²¾åº¦ç®—æœ¯åº“ä¾èµ–
              libgmp-dev \
              # å…¶ä»–å¸¸è§çš„Coqä¾èµ–
              g++ \
              # clangç¼–è¯‘å™¨ï¼ˆcoq-coquelicotä¾èµ–ï¼‰
              clang \
              # æ•°å­¦åº“ä¾èµ–
              liblapack-dev \
              libopenblas-dev \
              && rm -rf /var/lib/apt/lists/*
          
          # è®¾ç½®Opamç¯å¢ƒï¼ˆæ·»åŠ --no-depextsé¿å…å¤–éƒ¨ä¾èµ–æ£€æŸ¥ï¼‰
          RUN opam init --disable-sandboxing --yes --compiler=4.14.0 --no-depexts
          RUN opam update
          
          # æ·»åŠ Coqä»“åº“
          RUN opam repo add coq-released https://coq.inria.fr/opam/released
          RUN opam update
          
          # å®‰è£…Coqï¼ˆæŒ‡å®šç¡®åˆ‡ç‰ˆæœ¬ï¼‰
          RUN opam install --yes --no-depexts coq.8.16.1
          
          # å®‰è£…Coqæ ‡å‡†åº“å’Œå¸¸ç”¨åº“ - ä½¿ç”¨æ­£ç¡®çš„åŒ…å
          RUN opam install --yes --no-depexts coq-mathcomp-ssreflect.1.15.0
          RUN opam install --yes --no-depexts coq-mathcomp-algebra.1.15.0
          RUN opam install --yes --no-depexts coq-mathcomp-field.1.15.0
          
          # å®‰è£…åˆ†æåº“ï¼ˆåŒ…å«â„ç±»å‹å®šä¹‰ï¼‰- ä½¿ç”¨--no-depextså‚æ•°
          RUN opam install --yes --no-depexts coq-coquelicot
          
          # å®‰è£…å…¶ä»–å¸¸ç”¨åº“
          RUN opam install --yes --no-depexts coq-flocq
          RUN opam install --yes --no-depexts coq-interval
          
          # å®‰è£…æ¦‚ç‡è®ºç›¸å…³åº“ - å…ˆæ£€æŸ¥å¯ç”¨ç‰ˆæœ¬
          RUN opam install --yes --no-depexts coq-infotheo || \
              (echo "å°è¯•å®‰è£…coq-infotheoå¤±è´¥ï¼Œæ£€æŸ¥å¯ç”¨ç‰ˆæœ¬..." && \
               opam list --available coq-infotheo)
          
          # å¦‚æœcoq-infotheoå®‰è£…å¤±è´¥ï¼Œå°è¯•å®‰è£…ä¸æŒ‡å®šç‰ˆæœ¬
          RUN opam install --yes --no-depexts coq-infotheo || echo "coq-infotheoå¯èƒ½æ— æ³•å®‰è£…ï¼Œç»§ç»­..."
          
          # æ¸…ç†Opamç¼“å­˜å’Œä¸éœ€è¦çš„æ–‡ä»¶
          RUN opam clean --all --yes && \
              rm -rf /root/.cache && \
              rm -rf /tmp/* && \
              rm -rf /var/cache/apt/* && \
              apt-get autoremove -y && \
              apt-get clean -y
          
          # è®¾ç½®å·¥ä½œç›®å½•
          WORKDIR /workspace
          
          # éªŒè¯Coqå®‰è£… - ä½¿ç”¨opam execç¡®ä¿æ‰¾åˆ°coqc
          RUN opam exec -- coqc --version
          
          # éªŒè¯å®‰è£…çš„åº“
          RUN echo "éªŒè¯å®‰è£…çš„Coqåº“..."
          RUN opam list | grep -E "coq|mathcomp" || echo "OpamåŒ…åˆ—è¡¨"
          
          # è®¾ç½®é»˜è®¤å‘½ä»¤
          CMD ["opam", "exec", "--", "coqc", "--version"]
          EOF
          
          echo "Dockerfile.fixedå·²åˆ›å»º"
      
      - name: æ¸…ç†ç£ç›˜ç©ºé—´
        run: |
          echo "æ¸…ç†ç£ç›˜ç©ºé—´..."
          df -h
          sudo apt-get clean || true
          sudo rm -rf /var/lib/apt/lists/* || true
          docker system prune -f || true
          df -h
      
      - name: è®¾ç½®Dockeræ„å»ºç¯å¢ƒ
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:master
      
      - name: æ£€æŸ¥GitHub Packagesæƒé™
        run: |
          echo "æ£€æŸ¥GitHub Packagesæƒé™..."
          echo "ä»“åº“: ${{ github.repository }}"
          echo "ä»“åº“åç§°: ${{ github.repository }}"
          echo "ä»“åº“æ‰€æœ‰è€…: ${{ github.repository_owner }}"
          echo "äº‹ä»¶: ${{ github.event_name }}"
          
          # æ£€æŸ¥æ˜¯å¦å…·æœ‰åˆ›å»ºåŒ…çš„æƒé™
          if [[ "${{ github.repository }}" == *"/"* ]]; then
            OWNER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
            REPO=$(echo "${{ github.repository }}" | cut -d'/' -f2)
            echo "æ‰€æœ‰è€…: $OWNER"
            echo "ä»“åº“å: $REPO"
            
            # å¦‚æœæ˜¯ç»„ç»‡ä»“åº“ï¼Œå¯èƒ½éœ€è¦ç‰¹å®šæƒé™
            if [[ "$OWNER" != "${{ github.actor }}" ]]; then
              echo "âš ï¸ è¿™æ˜¯ç»„ç»‡ä»“åº“ï¼Œå¯èƒ½éœ€è¦é¢å¤–æƒé™æ¥åˆ›å»ºåŒ…"
              echo "å»ºè®®ï¼šä½¿ç”¨ä¸ªäººå‘½åç©ºé—´æˆ–ç¡®ä¿æœ‰ç»„ç»‡åŒ…åˆ›å»ºæƒé™"
            fi
          fi
      
      - name: è½¬æ¢ä»“åº“åç§°ä¸ºå°å†™
        id: lowercase
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "åŸå§‹ä»“åº“å: ${{ github.repository }}"
          echo "å°å†™ä»“åº“å: $REPO_LOWER"
          echo "repository_lower=$REPO_LOWER" >> $GITHUB_OUTPUT
      
      - name: æ¸…ç†Dockeræ„å»ºç¼“å­˜
        run: |
          echo "æ¸…ç†Dockeræ„å»ºç¼“å­˜..."
          docker builder prune -f --all || true
      
      - name: æ„å»ºDockeré•œåƒï¼ˆä¸æ¨é€ï¼Œåªæ„å»ºå’Œç¼“å­˜ï¼‰
        id: build-docker
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.fixed
          # ä½¿ç”¨GitHub Actionsç¼“å­˜ï¼Œä¸æ¨é€åˆ°è¿œç¨‹ä»“åº“
          tags: |
            ${{ env.DOCKER_IMAGE_NAME }}:latest
          cache-from: |
            type=gha,scope=coq-ci
          cache-to: |
            type=gha,scope=coq-ci,mode=max
          push: false  # ä¸æ¨é€åˆ°è¿œç¨‹ä»“åº“
          platforms: linux/amd64
          outputs: type=docker,dest=/tmp/coq-image.tar  # ç›´æ¥è¾“å‡ºåˆ°æ–‡ä»¶
      
      - name: åŠ è½½Dockeré•œåƒåˆ°æœ¬åœ°
        run: |
          echo "åŠ è½½Dockeré•œåƒåˆ°æœ¬åœ°..."
          docker load -i /tmp/coq-image.tar
          docker tag ${{ env.DOCKER_IMAGE_NAME }}:latest coq-ci:latest
          echo "é•œåƒå·²åŠ è½½å¹¶æ ‡è®°ä¸º coq-ci:latest"
          docker images | grep coq-ci
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶é‡Šæ”¾ç©ºé—´
          rm -f /tmp/coq-image.tar
      
      - name: å°è¯•æ¨é€åˆ°GitHub Packagesï¼ˆå¯é€‰çš„ï¼Œå¦‚æœæƒé™å…è®¸ï¼‰
        if: github.event_name != 'pull_request'
        continue-on-error: true  # å³ä½¿æ¨é€å¤±è´¥ä¹Ÿç»§ç»­
        run: |
          echo "å°è¯•æ¨é€åˆ°GitHub Packages..."
          
          # ä½¿ç”¨ä¸ªäººå‘½åç©ºé—´ï¼Œé¿å…ç»„ç»‡æƒé™é—®é¢˜
          PERSONAL_NAMESPACE="${{ github.actor }}"
          echo "ä½¿ç”¨ä¸ªäººå‘½åç©ºé—´: $PERSONAL_NAMESPACE"
          
          # ç™»å½•åˆ°GitHubå®¹å™¨ä»“åº“
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # æ ‡è®°é•œåƒ
          docker tag ${{ env.DOCKER_IMAGE_NAME }}:latest ghcr.io/$PERSONAL_NAMESPACE/coq-ci:${{ github.sha }}
          docker tag ${{ env.DOCKER_IMAGE_NAME }}:latest ghcr.io/$PERSONAL_NAMESPACE/coq-ci:latest
          
          # å°è¯•æ¨é€
          echo "æ¨é€é•œåƒåˆ° ghcr.io/$PERSONAL_NAMESPACE/coq-ci:${{ github.sha }}"
          docker push ghcr.io/$PERSONAL_NAMESPACE/coq-ci:${{ github.sha }} || echo "æ¨é€å¸¦SHAæ ‡ç­¾å¤±è´¥ï¼Œç»§ç»­..."
          
          echo "æ¨é€é•œåƒåˆ° ghcr.io/$PERSONAL_NAMESPACE/coq-ci:latest"
          docker push ghcr.io/$PERSONAL_NAMESPACE/coq-ci:latest || echo "æ¨é€latestæ ‡ç­¾å¤±è´¥ï¼Œç»§ç»­..."
          
          echo "æ¨é€å®Œæˆï¼ˆéƒ¨åˆ†å¯èƒ½å¤±è´¥ï¼‰"
      
      - name: éªŒè¯Dockeré•œåƒ
        run: |
          echo "éªŒè¯Dockeré•œåƒ..."
          
          # æµ‹è¯•é•œåƒæ˜¯å¦èƒ½è¿è¡Œ
          docker run --rm ${{ env.DOCKER_IMAGE_NAME }}:latest echo "Dockeré•œåƒæµ‹è¯•æˆåŠŸ"
          
          # æ£€æŸ¥Coqæ˜¯å¦å®‰è£… - ä½¿ç”¨opam exec
          docker run --rm ${{ env.DOCKER_IMAGE_NAME }}:latest opam exec -- which coqc && echo "âœ“ coqcå·²å®‰è£…" || echo "âœ— coqcæœªå®‰è£…"
          docker run --rm ${{ env.DOCKER_IMAGE_NAME }}:latest opam exec -- coqc --version || echo "æ— æ³•è·å–coqcç‰ˆæœ¬"
          
          # æ£€æŸ¥å…³é”®åº“æ˜¯å¦å®‰è£…
          echo "æ£€æŸ¥å…³é”®åº“æ˜¯å¦å®‰è£…..."
          docker run --rm ${{ env.DOCKER_IMAGE_NAME }}:latest opam exec -- opam list | grep -E "coq-mathcomp|coq-coquelicot|coq-infotheo" || echo "åº“åˆ—è¡¨æ£€æŸ¥å¤±è´¥"
          
          echo "Dockeré•œåƒéªŒè¯å®Œæˆ"
      
      - name: ä¿å­˜å‹ç¼©é•œåƒä¸ºtar.gzåŒ…
        run: |
          echo "ä¿å­˜å‹ç¼©é•œåƒ..."
          df -h
          
          # æ¸…ç†ä¹‹å‰å¯èƒ½å­˜åœ¨çš„æ–‡ä»¶
          rm -f coq-image.tar coq-image.tar.gz
          
          # ä½¿ç”¨gzipå‹ç¼©ä¿å­˜é•œåƒï¼Œå‡å°‘ç£ç›˜å ç”¨
          docker save ${{ env.DOCKER_IMAGE_NAME }}:latest | gzip -c > coq-image.tar.gz
          
          echo "é•œåƒå·²å‹ç¼©ä¿å­˜ä¸ºcoq-image.tar.gz"
          ls -lh coq-image.tar.gz
          
          # éªŒè¯å‹ç¼©æ–‡ä»¶
          if [ -f "coq-image.tar.gz" ]; then
            echo "å‹ç¼©æ–‡ä»¶å¤§å°: $(ls -lh coq-image.tar.gz | awk '{print $5}')"
            echo "å‹ç¼©æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥..."
            gzip -t coq-image.tar.gz && echo "âœ“ å‹ç¼©æ–‡ä»¶å®Œæ•´" || echo "âœ— å‹ç¼©æ–‡ä»¶æŸå"
          else
            echo "é”™è¯¯: å‹ç¼©æ–‡ä»¶æœªåˆ›å»º"
            exit 1
          fi
          
          df -h
      
      - name: æ¸…ç†Dockerç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶
        run: |
          echo "æ¸…ç†Dockerç¼“å­˜..."
          docker system prune -f || true
          df -h
      
      - name: ä¸Šä¼ Dockeré•œåƒç¼“å­˜
        uses: actions/upload-artifact@v4
        with:
          name: coq-docker-image
          path: coq-image.tar.gz
          retention-days: 1

  # é˜¶æ®µ2: ä»£ç é¢„å¤„ç†å’Œæ–‡ä»¶å‡†å¤‡
  prepare:
    name: å‡†å¤‡Coqæ–‡ä»¶
    runs-on: ubuntu-22.04
    needs: build-docker
    timeout-minutes: 10
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½Dockeré•œåƒ
        uses: actions/download-artifact@v4
        with:
          name: coq-docker-image
          path: .
      
      - name: åŠ è½½Dockeré•œåƒ
        run: |
          echo "åŠ è½½å‹ç¼©çš„Dockeré•œåƒ..."
          gunzip -c coq-image.tar.gz | docker load
          echo "å·²åŠ è½½çš„Dockeré•œåƒ:"
          docker images | grep "${{ env.DOCKER_IMAGE_NAME }}"
          
          # æ¸…ç†ä¸‹è½½çš„æ–‡ä»¶
          rm -f coq-image.tar.gz
      
      - name: å¤„ç†Coqæ–‡ä»¶
        run: |
          echo "å‡†å¤‡Coqæ–‡ä»¶..."
          
          # åˆ›å»ºæ ‡å‡†æ–‡ä»¶ç»“æ„
          mkdir -p src
          
          # é¦–å…ˆæŸ¥æ‰¾æ‰€æœ‰Coqæ–‡ä»¶
          COQ_FILES=$(find . -name "*.v" -type f | head -5)
          TEXT_FILES=$(find . -name "*.txt" -type f | head -5)
          
          echo "æ‰¾åˆ°çš„Coqæ–‡ä»¶:"
          echo "$COQ_FILES"
          
          echo "æ‰¾åˆ°çš„æ–‡æœ¬æ–‡ä»¶:"
          echo "$TEXT_FILES"
          
          # ä¼˜å…ˆä½¿ç”¨.væ–‡ä»¶
          if [ -n "$COQ_FILES" ]; then
            FIRST_COQ=$(echo "$COQ_FILES" | head -1)
            echo "ä½¿ç”¨ç¬¬ä¸€ä¸ªCoqæ–‡ä»¶: $FIRST_COQ"
            cp "$FIRST_COQ" "src/FormalCert_Probability_System.v"
          # å¦‚æœæ²¡æœ‰.væ–‡ä»¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰"ä¸Š.txt"æ–‡ä»¶
          elif [ -f "ä¸Š.txt" ]; then
            echo "ä½¿ç”¨ä¸­æ–‡æ–‡ä»¶ ä¸Š.txt"
            cp "ä¸Š.txt" "src/FormalCert_Probability_System.v"
          # å°è¯•å…¶ä»–æ–‡æœ¬æ–‡ä»¶
          elif [ -n "$TEXT_FILES" ]; then
            FIRST_TEXT=$(echo "$TEXT_FILES" | head -1)
            echo "ä½¿ç”¨ç¬¬ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶: $FIRST_TEXT"
            cp "$FIRST_TEXT" "src/FormalCert_Probability_System.v"
          else
            echo "è­¦å‘Š: æœªæ‰¾åˆ°Coqæˆ–æ–‡æœ¬æ–‡ä»¶ï¼Œåˆ›å»ºç¤ºä¾‹æ–‡ä»¶"
            # ä½¿ç”¨å¤šä¸ªechoå‘½ä»¤åˆ›å»ºæ–‡ä»¶ï¼Œå®Œå…¨é¿å…here-documenté—®é¢˜
            echo '(* FormalCert Probability System - Example File *)' > src/FormalCert_Probability_System.v
            echo 'Require Import Coq.Arith.Arith.' >> src/FormalCert_Probability_System.v
            echo 'Require Import Coq.Lists.List.' >> src/FormalCert_Probability_System.v
            echo '' >> src/FormalCert_Probability_System.v
            echo '(* Example theorem *)' >> src/FormalCert_Probability_System.v
            echo 'Theorem example_theorem : 1 + 1 = 2.' >> src/FormalCert_Probability_System.v
            echo 'Proof.' >> src/FormalCert_Probability_System.v
            echo '  simpl.' >> src/FormalCert_Probability_System.v
            echo '  reflexivity.' >> src/FormalCert_Probability_System.v
            echo 'Qed.' >> src/FormalCert_Probability_System.v
            echo '' >> src/FormalCert_Probability_System.v
            echo '(* Probability example *)' >> src/FormalCert_Probability_System.v
            echo 'Definition probability_space := Type.' >> src/FormalCert_Probability_System.v
            echo 'Definition event := Prop.' >> src/FormalCert_Probability_System.v
            echo 'Definition measure : probability_space -> event -> nat :=' >> src/FormalCert_Probability_System.v
            echo '  fun _ _ => 0.' >> src/FormalCert_Probability_System.v
            echo '' >> src/FormalCert_Probability_System.v
            echo '(* Test compilation *)' >> src/FormalCert_Probability_System.v
            echo 'Example test_example : True.' >> src/FormalCert_Probability_System.v
            echo 'Proof.' >> src/FormalCert_Probability_System.v
            echo '  exact I.' >> src/FormalCert_Probability_System.v
            echo 'Qed.' >> src/FormalCert_Probability_System.v
          fi
          
          # ç¡®ä¿æ–‡ä»¶ç¼–ç æ­£ç¡®
          if [ -f "src/FormalCert_Probability_System.v" ]; then
            echo "ä¿®å¤æ–‡ä»¶ç¼–ç ..."
            # ä½¿ç”¨æ›´å®‰å…¨çš„ç¼–ç è½¬æ¢æ–¹æ³•
            if command -v iconv &> /dev/null; then
              iconv -f utf-8 -t utf-8 "src/FormalCert_Probability_System.v" > "src/temp.v" 2>/dev/null && mv "src/temp.v" "src/FormalCert_Probability_System.v" || true
            else
              # å¦‚æœæ²¡æœ‰iconvï¼Œç›´æ¥ä½¿ç”¨åŸæ–‡ä»¶
              echo "iconvä¸å¯ç”¨ï¼Œè·³è¿‡ç¼–ç è½¬æ¢"
            fi
          fi
          
          # åˆ›å»ºæ–‡ä»¶åˆ—è¡¨
          if [ -d "src/" ]; then
            find src/ -name "*.v" > coq_files.txt 2>/dev/null || echo "src/FormalCert_Probability_System.v" > coq_files.txt
          else
            echo "src/FormalCert_Probability_System.v" > coq_files.txt
          fi
          
          echo "æ–‡ä»¶åˆ—è¡¨:"
          cat coq_files.txt
          
          echo "ä¸»æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
          if [ -f "src/FormalCert_Probability_System.v" ]; then
            head -20 "src/FormalCert_Probability_System.v" 2>/dev/null || echo "æ–‡ä»¶ä¸ºç©ºæˆ–æ— æ³•è¯»å–"
          else
            echo "ä¸»æ–‡ä»¶ä¸å­˜åœ¨"
          fi
      
      - name: éªŒè¯æ–‡ä»¶å†…å®¹
        run: |
          echo "éªŒè¯Coqæ–‡ä»¶å†…å®¹..."
          if [ -f "src/FormalCert_Probability_System.v" ]; then
            echo "æ–‡ä»¶å¤§å°: $(wc -l < src/FormalCert_Probability_System.v) è¡Œ"
            echo "å‰10è¡Œå†…å®¹:"
            head -10 src/FormalCert_Probability_System.v
          else
            echo "é”™è¯¯: æœªæ‰¾åˆ°Coqæ–‡ä»¶"
            exit 1
          fi
      
      - name: ä¸Šä¼ å¤„ç†åçš„æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: coq-source-files
          path: |
            src/
            coq_files.txt
          retention-days: 7

  # é˜¶æ®µ3: è¯­æ³•æ£€æŸ¥ï¼ˆåœ¨Dockerä¸­è¿è¡Œï¼‰
  syntax-check:
    name: Coqè¯­æ³•æ£€æŸ¥
    runs-on: ubuntu-22.04
    needs: [build-docker, prepare]
    timeout-minutes: 30
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½æºä»£ç æ–‡ä»¶
        uses: actions/download-artifact@v4
        with:
          name: coq-source-files
          path: .
      
      - name: ä¸‹è½½Dockeré•œåƒæ–‡ä»¶
        uses: actions/download-artifact@v4
        with:
          name: coq-docker-image
          path: .
      
      - name: åŠ è½½Dockeré•œåƒ
        run: |
          echo "åŠ è½½å‹ç¼©çš„Dockeré•œåƒ..."
          gunzip -c coq-image.tar.gz | docker load
          echo "é•œåƒåŠ è½½å®Œæˆ"
          rm -f coq-image.tar.gz
      
      - name: è¿è¡Œè¯­æ³•æ£€æŸ¥
        run: |
          echo "åœ¨Dockerå®¹å™¨ä¸­è¿è¡Œè¯­æ³•æ£€æŸ¥..."
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºCoqå·¥ä½œ
          mkdir -p coq_workspace
          cp -r src coq_workspace/
          
          # åœ¨Dockerå®¹å™¨ä¸­è¿è¡ŒCoqç¼–è¯‘å™¨
          docker run --rm \
            -v $(pwd)/coq_workspace:/workspace \
            -w /workspace \
            ${{ env.DOCKER_IMAGE_NAME }}:latest \
            bash -c "
              echo '=== Coqç¯å¢ƒæ£€æŸ¥ ==='
              
              # æ£€æŸ¥åŸºæœ¬å‘½ä»¤
              opam exec -- which coqc && opam exec -- coqc --version || echo 'coqcæœªå®‰è£…'
              opam exec -- which coqtop && opam exec -- coqtop --version || echo 'coqtopæœªå®‰è£…'
              
              echo '=== æ–‡ä»¶æ£€æŸ¥ ==='
              ls -la /workspace/src/
              
              if [ -f '/workspace/src/FormalCert_Probability_System.v' ]; then
                echo 'å¼€å§‹è¯­æ³•æ£€æŸ¥...'
                
                cd src
                
                # å°è¯•ç¼–è¯‘æ–‡ä»¶
                echo 'ç¼–è¯‘ä¸»æ–‡ä»¶...'
                
                # ä½¿ç”¨æ›´ç®€å•çš„æ£€æŸ¥æ–¹æ³•
                if head -n 5 FormalCert_Probability_System.v | grep -q 'Require\|From\|Import'; then
                  echo 'æ£€æµ‹åˆ°å¯¼å…¥è¯­å¥ï¼Œå°è¯•ç¼–è¯‘...'
                  
                  # åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•æ–‡ä»¶ï¼ˆä½¿ç”¨æ ‡å‡†åº“ï¼‰- ä½¿ç”¨echoé¿å…here-documenté—®é¢˜
                  echo 'Require Import Coq.Init.Prelude.' > test_simple.v
                  echo 'Theorem simple_test : True.' >> test_simple.v
                  echo 'Proof. exact I. Qed.' >> test_simple.v
                  
                  if opam exec -- coqc test_simple.v; then
                    echo 'âœ“ Coqç¯å¢ƒæ­£å¸¸'
                    
                    # å°è¯•ç¼–è¯‘å®é™…æ–‡ä»¶çš„å‰50è¡Œ
                    head -50 FormalCert_Probability_System.v > test_actual.v
                    if opam exec -- coqc -q test_actual.v 2>&1; then
                      echo 'âœ“ è¯­æ³•æ£€æŸ¥é€šè¿‡'
                    else
                      echo 'âš ï¸ æ–‡ä»¶å¯èƒ½æœ‰è¯­æ³•é”™è¯¯æˆ–ç¼ºå°‘ä¾èµ–'
                      echo 'æ˜¾ç¤ºå‰50è¡Œå†…å®¹:'
                      head -50 FormalCert_Probability_System.v
                      exit 0  # ä¸å¤±è´¥ï¼Œç»§ç»­åç»­æ­¥éª¤
                    fi
                  else
                    echo 'âš ï¸ Coqç¯å¢ƒæœ‰é—®é¢˜'
                    exit 0  # ä¸å¤±è´¥ï¼Œç»§ç»­åç»­æ­¥éª¤
                  fi
                else
                  echo 'æ–‡ä»¶ä¸åŒ…å«å¯¼å…¥è¯­å¥ï¼Œè·³è¿‡ç¼–è¯‘æ£€æŸ¥'
                  echo 'æ–‡ä»¶å†…å®¹å‰10è¡Œ:'
                  head -10 FormalCert_Probability_System.v
                fi
                
              else
                echo 'é”™è¯¯: æœªæ‰¾åˆ°Coqæºæ–‡ä»¶'
                exit 1
              fi
            "
      
      - name: ç”Ÿæˆè¯­æ³•æ£€æŸ¥æŠ¥å‘Š
        if: always()
        run: |
          echo "ç”Ÿæˆè¯­æ³•æ£€æŸ¥æŠ¥å‘Š..."
          
          cat > syntax_report.md << EOF
          # Coqè¯­æ³•æ£€æŸ¥æŠ¥å‘Š
          
          ## åŸºæœ¬ä¿¡æ¯
          - **æ£€æŸ¥æ—¶é—´**: $(date)
          - **ä»“åº“**: ${{ github.repository }}
          - **æäº¤**: ${{ github.sha }}
          - **åˆ†æ”¯**: ${{ github.ref_name }}
          
          ## ç¯å¢ƒçŠ¶æ€
          - **Dockeré•œåƒ**: ${{ env.DOCKER_IMAGE_NAME }}:latest
          - **æ„å»ºçŠ¶æ€**: ${{ needs.build-docker.result }}
          - **æƒé™ä¿®å¤**: ä½¿ç”¨GitHub Actionsç¼“å­˜ï¼Œé¿å…ç»„ç»‡åŒ…æƒé™é—®é¢˜
          
          ## æ–‡ä»¶çŠ¶æ€
          EOF
          
          if [ -f "src/FormalCert_Probability_System.v" ]; then
            LINES=$(wc -l < src/FormalCert_Probability_System.v 2>/dev/null || echo "0")
            SIZE=$(du -h src/FormalCert_Probability_System.v 2>/dev/null | cut -f1 || echo "æœªçŸ¥")
            
            echo "- **ä¸»æ–‡ä»¶**: src/FormalCert_Probability_System.v" >> syntax_report.md
            echo "- **æ–‡ä»¶å¤§å°**: $LINES è¡Œ ($SIZE)" >> syntax_report.md
            echo "- **æ–‡ä»¶ç¼–ç **: $(file -b --mime-encoding src/FormalCert_Probability_System.v 2>/dev/null || echo 'æœªçŸ¥')" >> syntax_report.md
            
            echo "## å†…å®¹æ‘˜è¦" >> syntax_report.md
            echo '```coq' >> syntax_report.md
            head -20 src/FormalCert_Probability_System.v >> syntax_report.md 2>/dev/null || echo "æ— æ³•è¯»å–æ–‡ä»¶" >> syntax_report.md
            echo '```' >> syntax_report.md
            
            # ç»Ÿè®¡ä¿¡æ¯
            echo "## ç»Ÿè®¡ä¿¡æ¯" >> syntax_report.md
            echo "- **å®šç†æ•°é‡**: $(grep -c -i 'theorem\|lemma\|corollary' src/FormalCert_Probability_System.v 2>/dev/null || echo '0')" >> syntax_report.md
            echo "- **å®šä¹‰æ•°é‡**: $(grep -c -i '^Definition\|^Inductive\|^Fixpoint' src/FormalCert_Probability_System.v 2>/dev/null || echo '0')" >> syntax_report.md
            echo "- **å¯¼å…¥æ•°é‡**: $(grep -c -i 'Require\|Import\|From' src/FormalCert_Probability_System.v 2>/dev/null || echo '0')" >> syntax_report.md
          else
            echo "## é”™è¯¯ä¿¡æ¯" >> syntax_report.md
            echo "- æœªæ‰¾åˆ°Coqæºæ–‡ä»¶" >> syntax_report.md
          fi
          
          echo "## æ£€æŸ¥ç»“æœ" >> syntax_report.md
          echo "- **çŠ¶æ€**: ${{ job.status }}" >> syntax_report.md
          echo "- **ç»“è®º**: $(if [ '${{ job.status }}' = 'success' ]; then echo 'é€šè¿‡'; else echo 'éœ€è¦æ£€æŸ¥'; fi)" >> syntax_report.md
          
          cat syntax_report.md
      
      - name: ä¸Šä¼ è¯­æ³•æ£€æŸ¥æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: syntax-check-report
          path: syntax_report.md

  # é˜¶æ®µ4: å®šç†éªŒè¯ï¼ˆåˆ†æ­¥è¿›è¡Œï¼‰
  theorem-verify:
    name: å®šç†éªŒè¯
    runs-on: ubuntu-22.04
    needs: [syntax-check, build-docker]
    timeout-minutes: 45
    
    steps:
      - name: å‡†å¤‡ç¯å¢ƒ
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½æºä»£ç 
        uses: actions/download-artifact@v4
        with:
          name: coq-source-files
          path: .
      
      - name: ä¸‹è½½Dockeré•œåƒæ–‡ä»¶
        uses: actions/download-artifact@v4
        with:
          name: coq-docker-image
          path: .
      
      - name: åŠ è½½Dockeré•œåƒ
        run: |
          echo "åŠ è½½å‹ç¼©çš„Dockeré•œåƒ..."
          gunzip -c coq-image.tar.gz | docker load
          echo "é•œåƒåŠ è½½å®Œæˆ"
          rm -f coq-image.tar.gz
      
      - name: åŸºç¡€éªŒè¯
        run: |
          echo "è¿è¡ŒåŸºç¡€å®šç†éªŒè¯..."
          
          docker run --rm \
            -v $(pwd):/workspace \
            -w /workspace \
            ${{ env.DOCKER_IMAGE_NAME }}:latest \
            bash -c "
              echo '=== å®šç†éªŒè¯å¼€å§‹ ==='
              
              if [ -f 'src/FormalCert_Probability_System.v' ]; then
                echo 'æ£€æŸ¥æ–‡ä»¶...'
                
                # åˆ›å»ºæµ‹è¯•ç¯å¢ƒ
                mkdir -p test_coq
                cp src/FormalCert_Probability_System.v test_coq/
                cd test_coq
                
                # å°è¯•ç¼–è¯‘å‰100è¡Œ
                echo 'éªŒè¯å‰100è¡Œ...'
                head -100 FormalCert_Probability_System.v > verify_100.v
                
                # è®¾ç½®è¶…æ—¶ï¼Œä½¿ç”¨opam exec
                timeout 300s opam exec -- coqc -q verify_100.v 2>&1 | tee verify_output.txt
                
                VERIFY_EXIT=\${PIPESTATUS[0]}
                
                if [ \$VERIFY_EXIT -eq 0 ]; then
                  echo 'âœ“ åŸºç¡€éªŒè¯é€šè¿‡'
                elif [ \$VERIFY_EXIT -eq 124 ]; then
                  echo 'âš ï¸ éªŒè¯è¶…æ—¶ï¼ˆ5åˆ†é’Ÿï¼‰'
                else
                  echo 'å°è¯•æ›´ç®€å•çš„éªŒè¯...'
                  
                  # æå–ç¬¬ä¸€ä¸ªå®šç†
                  echo 'æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå®šç†...'
                  FIRST_THEOREM_LINE=\$(grep -n -i 'theorem\|lemma' FormalCert_Probability_System.v | head -1 | cut -d: -f1)
                  
                  if [ -n \"\$FIRST_THEOREM_LINE\" ]; then
                    echo \"ç¬¬ä¸€ä¸ªå®šç†åœ¨ç¬¬ \$FIRST_THEOREM_LINE è¡Œ\"
                    
                    # æå–å®šç†åŠå…¶è¯æ˜
                    START=\$((FIRST_THEOREM_LINE > 10 ? FIRST_THEOREM_LINE - 10 : 1))
                    END=\$((FIRST_THEOREM_LINE + 50))
                    
                    sed -n \"\${START},\${END}p\" FormalCert_Probability_System.v > theorem_test.v
                    
                    echo 'å°è¯•ç¼–è¯‘å•ä¸ªå®šç†...'
                    if opam exec -- coqc -q theorem_test.v 2>&1; then
                      echo 'âœ“ å•ä¸ªå®šç†éªŒè¯é€šè¿‡'
                    else
                      echo 'âš ï¸ å•ä¸ªå®šç†éªŒè¯å¤±è´¥'
                      echo 'å®šç†å†…å®¹:'
                      head -20 theorem_test.v
                      exit 0  # ä¸å¤±è´¥é€€å‡º
                    fi
                  else
                    echo 'æœªæ‰¾åˆ°å®šç†ï¼Œæ£€æŸ¥æ–‡ä»¶å†…å®¹...'
                    echo 'æ–‡ä»¶å‰30è¡Œ:'
                    head -30 FormalCert_Probability_System.v
                    exit 0  # ä¸å¤±è´¥é€€å‡º
                  fi
                fi
                
                # ç»Ÿè®¡å®šç†
                echo '=== å®šç†ç»Ÿè®¡ ==='
                grep -c -i 'theorem\|lemma\|corollary' FormalCert_Probability_System.v 2>/dev/null || echo 0
                
              else
                echo 'é”™è¯¯: æœªæ‰¾åˆ°æºæ–‡ä»¶'
                exit 1
              fi
            "
      
      - name: ç”ŸæˆéªŒè¯æŠ¥å‘Š
        if: always()
        run: |
          echo "ç”ŸæˆéªŒè¯æŠ¥å‘Š..."
          
          cat > verify_report.md << EOF
          # å®šç†éªŒè¯æŠ¥å‘Š
          
          ## éªŒè¯ä¿¡æ¯
          - **éªŒè¯æ—¶é—´**: $(date)
          - **éªŒè¯æ¨¡å¼**: åŸºç¡€éªŒè¯
          - **è¿è¡ŒID**: ${{ github.run_id }}
          - **æäº¤**: ${{ github.sha }}
          
          ## éªŒè¯ç»“æœ
          - **çŠ¶æ€**: ${{ job.status }}
          - **Dockeré•œåƒ**: ${{ env.DOCKER_IMAGE_NAME }}:latest
          
          ## æ–‡ä»¶åˆ†æ
          EOF
          
          if [ -f "src/FormalCert_Probability_System.v" ]; then
            LINES=$(wc -l < src/FormalCert_Probability_System.v 2>/dev/null || echo "0")
            
            echo "- **æ–‡ä»¶å¤§å°**: $LINES è¡Œ" >> verify_report.md
            
            # å®šç†åˆ—è¡¨
            echo "## æ£€æµ‹åˆ°çš„å®šç†" >> verify_report.md
            grep -n -i "theorem\|lemma" src/FormalCert_Probability_System.v | head -20 | while read line; do
              echo "1. $line" >> verify_report.md
            done 2>/dev/null || echo "æœªæ£€æµ‹åˆ°å®šç†" >> verify_report.md
            
            # æ–‡ä»¶å†…å®¹é¢„è§ˆ
            echo "## æ–‡ä»¶é¢„è§ˆ" >> verify_report.md
            echo '```coq' >> verify_report.md
            head -30 src/FormalCert_Probability_System.v >> verify_report.md 2>/dev/null || echo "æ— æ³•è¯»å–æ–‡ä»¶" >> verify_report.md
            echo '```' >> verify_report.md
          fi
          
          echo "## å»ºè®®" >> verify_report.md
          if [ "${{ job.status }}" = "success" ]; then
            echo "- âœ… éªŒè¯é€šè¿‡ï¼Œå¯ä»¥ç»§ç»­å¼€å‘" >> verify_report.md
          else
            echo "- âš ï¸ éªŒè¯é‡åˆ°é—®é¢˜ï¼Œå»ºè®®æ£€æŸ¥Coqè¯­æ³•å’Œä¾èµ–" >> verify_report.md
            echo "- ğŸ“‹ æ£€æŸ¥Dockeré•œåƒæ˜¯å¦åŒ…å«æ‰€æœ‰å¿…è¦çš„Coqåº“" >> verify_report.md
            echo "- ğŸ”§ ç¡®ä¿æ–‡ä»¶ä½¿ç”¨UTF-8ç¼–ç ï¼Œä¸å«ç‰¹æ®Šå­—ç¬¦" >> verify_report.md
          fi
          
          cat verify_report.md
      
      - name: ä¸Šä¼ éªŒè¯æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: verify-report
          path: verify_report.md

  # é˜¶æ®µ5: ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
  summary:
    name: ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
    runs-on: ubuntu-22.04
    needs: [build-docker, prepare, syntax-check, theorem-verify]
    if: always()
    timeout-minutes: 5
    
    steps:
      - name: ç”Ÿæˆç»¼åˆæŠ¥å‘Š
        run: |
          echo "ç”Ÿæˆç»¼åˆæŠ¥å‘Š..."
          
          cat > summary_report.md << EOF
          # FormalCert Probability System - CI/CD ç»¼åˆæŠ¥å‘Š
          
          ## æ‰§è¡Œæ¦‚å†µ
          - **å·¥ä½œæµ**: ${{ github.workflow }}
          - **è¿è¡ŒID**: ${{ github.run_id }}
          - **è§¦å‘äº‹ä»¶**: ${{ github.event_name }}
          - **æäº¤**: ${{ github.sha }}
          - **åˆ†æ”¯**: ${{ github.ref }}
          - **æ‰§è¡Œæ—¶é—´**: $(date)
          
          ## é˜¶æ®µçŠ¶æ€
          | é˜¶æ®µ | çŠ¶æ€ | è¯¦æƒ… |
          |------|------|------|
          | æ„å»ºDockeré•œåƒ | ${{ needs.build-docker.result }} | æ„å»ºCoqå¼€å‘ç¯å¢ƒ |
          | æ–‡ä»¶å‡†å¤‡ | ${{ needs.prepare.result }} | å¤„ç†Coqæºæ–‡ä»¶ |
          | è¯­æ³•æ£€æŸ¥ | ${{ needs.syntax-check.result }} | éªŒè¯Coqè¯­æ³• |
          | å®šç†éªŒè¯ | ${{ needs.theorem-verify.result }} | éªŒè¯æ•°å­¦å®šç† |
          
          ## ç³»ç»Ÿä¿¡æ¯
          - **è¿è¡Œç¯å¢ƒ**: Ubuntu 22.04
          - **Dockeré•œåƒ**: ${{ env.DOCKER_IMAGE_NAME }}:latest
          - **ç¼“å­˜ç­–ç•¥**: ä½¿ç”¨GitHub Actionsç¼“å­˜ï¼Œé¿å…ç»„ç»‡åŒ…æƒé™é—®é¢˜
          - **Coqç‰ˆæœ¬**: 8.16.1
          
          ## å…³é”®ä¿®å¤
          1. **å®‰è£…clang**: è§£å†³coq-coquelicotä¾èµ–é—®é¢˜
          2. **ä¿æŒç®€å•**: é¿å…å¼•å…¥opam switchå’Œå¤æ‚çš„ç‰ˆæœ¬æ§åˆ¶
          3. **ä¼˜é›…å¤±è´¥**: å¦‚æœcoq-infotheoå®‰è£…å¤±è´¥ï¼Œç»§ç»­æ„å»º
          4. **åŸºæœ¬ç¯å¢ƒ**: ç¡®ä¿Coq 8.16.1å’Œæ ¸å¿ƒåº“æ­£ç¡®å®‰è£…
          5. **ç£ç›˜ä¼˜åŒ–**: ä½¿ç”¨gzipå‹ç¼©é•œåƒï¼Œæ¸…ç†ç¼“å­˜ï¼Œè§£å†³ç£ç›˜ç©ºé—´ä¸è¶³é—®é¢˜
          
          ## åç»­æ­¥éª¤
          
          EOF
          
          # æ ¹æ®çŠ¶æ€ç»™å‡ºå»ºè®®
          if [ "${{ needs.build-docker.result }}" = "success" ]; then
            echo "âœ… **Dockeré•œåƒæ„å»ºæˆåŠŸ** - Coq 8.16.1ç¯å¢ƒå·²é…ç½®" >> summary_report.md
          else
            echo "âŒ **Dockeré•œåƒæ„å»ºå¤±è´¥** - è¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š" >> summary_report.md
          fi
          
          if [ "${{ needs.syntax-check.result }}" = "success" ]; then
            echo "âœ… **è¯­æ³•æ£€æŸ¥é€šè¿‡** - Coqæ–‡ä»¶è¯­æ³•æ­£ç¡®" >> summary_report.md
          else
            echo "âš ï¸ **è¯­æ³•æ£€æŸ¥éœ€è¦å…³æ³¨** - è¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š" >> summary_report.md
          fi
          
          if [ "${{ needs.theorem-verify.result }}" = "success" ]; then
            echo "âœ… **å®šç†éªŒè¯é€šè¿‡** - æ•°å­¦å®šç†å¯ä»¥æ­£å¸¸éªŒè¯" >> summary_report.md
          else
            echo "âš ï¸ **å®šç†éªŒè¯éœ€è¦å…³æ³¨** - éƒ¨åˆ†å®šç†å¯èƒ½æ— æ³•éªŒè¯" >> summary_report.md
          fi
          
          echo "" >> summary_report.md
          echo "## è¯¦ç»†æŠ¥å‘Š" >> summary_report.md
          echo "è¯·æŸ¥çœ‹Artifactsä¸­çš„è¯¦ç»†æŠ¥å‘Šä»¥è·å–æ›´å¤šä¿¡æ¯ã€‚" >> summary_report.md
          
          cat summary_report.md
      
      - name: ä¸Šä¼ æ±‡æ€»æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: final-summary
          path: summary_report.md
          retention-days: 90
      
      - name: å‘é€å®Œæˆé€šçŸ¥
        if: always()
        run: |
          echo "CI/CDæµæ°´çº¿æ‰§è¡Œå®Œæˆ"
          echo "æœ€ç»ˆçŠ¶æ€: ${{ job.status }}"
          
          if [ "${{ job.status }}" = "failure" ]; then
            echo "âš ï¸ CI/CDæ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥è¯¦ç»†æŠ¥å‘Š"
          elif [ "${{ job.status }}" = "cancelled" ]; then
            echo "â¹ï¸ CI/CDæ‰§è¡Œè¢«å–æ¶ˆ"
          elif [ "${{ job.status }}" = "success" ]; then
            echo "âœ… CI/CDæ‰§è¡ŒæˆåŠŸ"
          else
            echo "CI/CDæ‰§è¡ŒçŠ¶æ€: ${{ job.status }}"
          fi
          
          echo "è¯¦ç»†æŠ¥å‘Šå·²ä¸Šä¼ åˆ°Artifacts"