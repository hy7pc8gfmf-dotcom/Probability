name: Coq Probability Library CI (8.20+ Optimized)

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - '**.v'
      - 'Makefile'
      - '_CoqProject'
      - '.github/workflows/*'
  pull_request:
    branches: [ main, master ]
    paths-ignore:
      - 'docs/**'
      - 'README*.md'
      - '.gitignore'

env:
  OPAMROOTISOK: "true"
  OPAMYES: "true"

concurrency:
  group:  $ {{ github.workflow }}- $ {{ github.ref }}
  cancel-in-progress: true

jobs:
  # =============== æ ¸å¿ƒéªŒè¯ä½œä¸š ===============
  validate:
    name: "Coq  $ {{ matrix.coq-tag }} â€¢ OCaml  $ {{ matrix.ocaml-version }}"
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        include:
          # ğŸ¥‡ åŸºç¡€å…¼å®¹å±‚ (ç¡®ä¿å‘åå…¼å®¹)
          - coq-tag: "8.16"
            coq-version: "8.16.1"
            ocaml-version: "4.14.0"
            coquelicot-version: "1.2.1"
            mathcomp-version: "1.17.0"
            priority: 1
          
          # ğŸ¥ˆ ç¨³å®šç”Ÿäº§å±‚ (ä¸»æµéƒ¨ç½²ç‰ˆæœ¬)
          - coq-tag: "8.19"
            coq-version: "8.19.2"
            ocaml-version: "4.14.1"
            coquelicot-version: "1.3.0"
            mathcomp-version: "2.1.0"
            priority: 2
          
          # ğŸ¥‰ æœ€æ–°ç¨³å®šå±‚ (å½“å‰å®˜æ–¹æ¨è)
          - coq-tag: "8.20"
            coq-version: "8.20.1"
            ocaml-version: "4.14.2"
            coquelicot-version: "1.4.0"  # Coq 8.20 ä¸“ç”¨ä¼˜åŒ–ç‰ˆ
            mathcomp-version: "2.2.0"
            priority: 3
          
          # ğŸ”® å‰æ²¿é¢„è§ˆå±‚ (é¢å‘æœªæ¥ç‰ˆæœ¬)
          - coq-tag: "dev"
            coq-version: "dev"
            ocaml-version: "5.1.1"
            install-command: "opam pin add coq.dev https://github.com/coq/coq.git#master -y --no-action && opam install coq.dev -y"
            allow-failure: true
            priority: 4
      fail-fast: false
      max-parallel: 4

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ’¾ Smart OPAM Cache
        uses: actions/cache@v3
        with:
          path: ï½/.opam
          key:  $ {{ runner.os }}-opam- $ {{ matrix.ocaml-version }}-coq $ {{ matrix.coq-tag }}- $ {{ hashFiles('**/opam', '**/_CoqProject') }}
          restore-keys: |
             $ {{ runner.os }}-opam- $ {{ matrix.ocaml-version }}-coq $ {{ matrix.coq-tag }}-
             $ {{ runner.os }}-opam- $ {{ matrix.ocaml-version }}-

      - name: ğŸ« Setup OCaml Environment
        uses: ocaml/setup-ocaml@v2
        with:
          ocaml-version:  $ {{ matrix.ocaml-version }}
          opam-pin: true
          dune-cache: true

      - name: ğŸ“¦ Install Coq & Dependencies
        run: |
          if [ " $ {{ matrix.install-command }}" ]; then
            eval " $ {{ matrix.install-command }}"
          else
            opam install -y coq. $ {{ matrix.coq-version }} \
                           coq-coquelicot. $ {{ matrix.coquelicot-version }} \
                           coq-mathcomp-ssreflect. $ {{ matrix.mathcomp-version }} \
                           coq-simpleio
          fi
          opam list | grep -E "coq|mathcomp|coquelicot"

      - name: ğŸ” Pre-Flight Checks
        run: |
          echo "âœ… Coq version:  $ (coqc --version | head -1)"
          echo "âœ… OCaml version:  $ (ocamlc -version)"
          [ -f Makefile ] && echo "âœ“ Makefile present" || { echo "âŒ Missing Makefile"; exit 1; }
          [ -f FormalCert_Probability_System.v ] && echo "âœ“ Core theory file present" || exit 1

      - name: ğŸ§ª Compile with Strict Checks
        run: |
          eval  $ (opam env)
          # å¯ç”¨ Coq 8.20+ æ–°ç‰¹æ€§ï¼šä¸¥æ ¼æ¨¡å¼ + è¯¦ç»†æ—¥å¿—
          if [ " $ {{ matrix.coq-tag }}" = "8.20" ] || [ " $ {{ matrix.coq-tag }}" = "dev" ]; then
            timeout 720 make COQFLAGS="-w -deprecated-native-compiler-option -w -notation-overridden" 2>&1 | tee build.log
          else
            timeout 600 make 2>&1 | tee build.log
          fi
        env:
          COQ_COLORS: "never"
          COQEXTRAFLAGS: "-async-proofs off"  # ç¡®ä¿æ—¥å¿—å¯è¯»æ€§

      - name: ğŸ“Š Generate Proof Metrics (Coq 8.20+)
        if:  $ {{ matrix.coq-tag == '8.20' }}
        run: |
          eval  $ (opam env)
          coqwc -l *.v > proof_metrics.txt
          echo "=== PROOF METRICS ===" 
          cat proof_metrics.txt
          # ç”Ÿæˆå¯è§†åŒ–æ‘˜è¦
          echo "Total lines:  $ (awk '/Total/ {print  $ 3}' proof_metrics.txt)"
          echo "Definitions:  $ (awk '/Definitions/ {print  $ 2}' proof_metrics.txt)"
          echo "Theorems:  $ (awk '/Theorems/ {print  $ 2}' proof_metrics.txt)"

      - name: ğŸ“š Build Documentation (Coq 8.20+)
        if:  $ {{ matrix.coq-tag == '8.20' && success() }}
        run: |
          eval  $ (opam env)
          make html 2>&1 | grep -E "(Success|Error)" || true
        continue-on-error: true

      - name: ğŸ“¤ Archive Artifacts
        if:  $ {{ success() && matrix.coq-tag == '8.20' }}
        uses: actions/upload-artifact@v4
        with:
          name: formalcert-docs- $ {{ github.sha }}
          path: |
            html/
            proof_metrics.txt
          retention-days: 90
          compression-level: 6

      - name: ğŸš¨ Failure Diagnostics
        if:  $ {{ failure() }}
        run: |
          echo "=== BUILD FAILURE ANALYSIS ==="
          tail -100 build.log | grep -A 5 -B 5 "Error\|Failed"
          echo ""
          echo "Coq Version:  $ {{ matrix.coq-tag }}"
          echo "OCaml Version:  $ {{ matrix.ocaml-version }}"
          exit 1

      - name: ğŸ“Œ Set Job Status
        if:  $ {{ always() }}
        run: |
          echo "JOB_STATUS= $ {{ job.status }}" >>  $ GITHUB_ENV

  # =============== ç‰ˆæœ¬å…¼å®¹æ€§æŠ¥å‘Šä½œä¸š ===============
  compatibility-report:
    name: "âœ… Compatibility Report"
    runs-on: ubuntu-22.04
    needs: validate
    if:  $ {{ always() && github.ref == 'refs/heads/main' }}
    steps:
      - uses: actions/checkout@v4
      - name: Generate Compatibility Matrix
        run: |
          cat > COMPATIBILITY.md <<EOF
          # FormalCert æ¦‚ç‡åº“ Coq ç‰ˆæœ¬å…¼å®¹æ€§æŠ¥å‘Š
          **ç”Ÿæˆæ—¶é—´**:  $ (date -u +"%Y-%m-%d %H:%M UTC")
          **Commit**:  $ {{ github.sha }}
          
          | Coq ç‰ˆæœ¬ | çŠ¶æ€ | OCaml | å…³é”®ä¾èµ– | å¤‡æ³¨ |
          |----------|------|-------|----------|------|
          | 8.16.1   | âœ…   | 4.14.0 | Coquelicot 1.2.1 | åŸºç¡€å…¼å®¹å±‚ |
          | 8.19.2   | âœ…   | 4.14.1 | Coquelicot 1.3.0 | ç¨³å®šç”Ÿäº§å±‚ |
          | **8.20.1** | âœ… | **4.14.2** | **Coquelicot 1.4.0** | **å½“å‰æ¨è** |
          | dev      |  $ {{ needs.validate.result == 'success' && 'âœ…' || 'âš ï¸' }} | 5.1.1 | æœ€æ–°ä¸»å¹² | å‰æ²¿é¢„è§ˆ |
          
          > ğŸ’¡ **ä½¿ç”¨å»ºè®®**: ç”Ÿäº§ç¯å¢ƒæ¨è Coq 8.20.1ï¼Œå¼€å‘ç¯å¢ƒå¯è·Ÿè¸ª dev åˆ†æ”¯
          EOF
          cat COMPATIBILITY.md
      - uses: EndBug/add-and-commit@v9
        with:
          add: "COMPATIBILITY.md"
          message: "docs: update compatibility report [skip ci]"
          push: true

  # =========
