name: FormalCert Probability System CI/CD with Proof Printing

on:
  push:
    branches: [main, develop, feature/*]
    paths:
      - '**.v'
      - '**.txt'
      - '**.md'
      - 'Makefile'
      - 'Dockerfile'
      - 'docker-compose.yml'
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  DOCKER_IMAGE_NAME: formalcert-coq-ci
  OPAMYES: "true"
  OPAMROOT: /usr/local/opam

jobs:
  build-docker:
    name: æ„å»ºCoqå¼€å‘é•œåƒ
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: åˆ›å»ºä¿®å¤åçš„Dockerfile
        run: |
          echo "åˆ›å»ºä¿®å¤åçš„Dockerfile..."
          
          # ä½¿ç”¨heredocåˆ›å»ºDockerfileï¼Œç¡®ä¿æ­£ç¡®çš„ç¼©è¿›
          cat > Dockerfile.fixed << 'EOF'
FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC
USER root

RUN mkdir -p /var/lib/apt/lists/partial && \
    chmod 0755 /var/lib/apt/lists/partial && \
    chown _apt:root /var/lib/apt/lists/partial && \
    mkdir -p /var/cache/apt/archives/partial && \
    chmod 0755 /var/cache/apt/archives/partial

RUN echo 'Acquire::GzipIndexes "false";' > /etc/apt/apt.conf.d/99disable-gzip-indexes && \
    echo 'Acquire::CompressionTypes::Order:: "gz";' >> /etc/apt/apt.conf.d/99disable-gzip-indexes

RUN apt-get update -o Acquire::http::No-Cache=true

RUN apt-get install -y --no-install-recommends \
    ca-certificates \
    apt-transport-https \
    gnupg \
    lsb-release \
    curl \
    wget \
    && rm -rf /var/lib/apt/lists/*

RUN mkdir -p /etc/apt/keyrings && \
    curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | gpg --dearmor -o /etc/apt/keyrings/githubcli-archive-keyring.gpg && \
    chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg

RUN apt-get update

RUN apt-get install -y --no-install-recommends \
    git \
    make \
    time \
    tar \
    gzip \
    && rm -rf /var/lib/apt/lists/*

RUN apt-get update && apt-get install -y --no-install-recommends \
    opam \
    m4 \
    pkg-config \
    bubblewrap \
    libgmp-dev \
    g++ \
    clang \
    liblapack-dev \
    libopenblas-dev \
    && rm -rf /var/lib/apt/lists/*

RUN opam init --disable-sandboxing --yes --compiler=4.14.0 --no-depexts
RUN opam update
RUN opam repo add coq-released https://coq.inria.fr/opam/released
RUN opam update
RUN opam install --yes --no-depexts coq.8.16.1
RUN opam install --yes --no-depexts coq-mathcomp-ssreflect.1.15.0
RUN opam install --yes --no-depexts coq-mathcomp-algebra.1.15.0
RUN opam install --yes --no-depexts coq-mathcomp-field.1.15.0
RUN opam install --yes --no-depexts coq-coquelicot
RUN opam install --yes --no-depexts coq-flocq
RUN opam install --yes --no-depexts coq-interval
RUN opam install --yes --no-depexts coq-mathcomp-analysis

RUN opam clean --all --yes && \
    rm -rf /root/.cache && \
    rm -rf /tmp/* && \
    rm -rf /var/cache/apt/* && \
    apt-get autoremove -y && \
    apt-get clean -y

WORKDIR /workspace

RUN opam exec -- coqc --version

RUN echo "æµ‹è¯•å®æ•°åº“..." && \
    echo 'From Coq Require Import Reals. Open Scope R_scope. Definition test_R : R := 0%R.' > test_R.v && \
    opam exec -- coqc test_R.v && echo "âœ“ Realsåº“å¯ç”¨" || echo "âš ï¸ Realsåº“æœ‰é—®é¢˜"

CMD ["opam", "exec", "--", "coqc", "--version"]
EOF
          
          echo "Dockerfile.fixedå·²åˆ›å»º"
      
      - name: æ„å»ºDockeré•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.fixed
          tags: ${{ env.DOCKER_IMAGE_NAME }}:latest
          push: false
          platforms: linux/amd64
          outputs: type=docker,dest=/tmp/coq-image.tar
      
      - name: åŠ è½½å¹¶æµ‹è¯•Dockeré•œåƒ
        run: |
          docker load -i /tmp/coq-image.tar
          echo "Dockeré•œåƒéªŒè¯:"
          docker run --rm ${{ env.DOCKER_IMAGE_NAME }}:latest opam exec -- coqc --version
          rm -f /tmp/coq-image.tar
      
      - name: ä¿å­˜å‹ç¼©é•œåƒ
        run: |
          docker save ${{ env.DOCKER_IMAGE_NAME }}:latest | gzip -c > coq-image.tar.gz
          echo "é•œåƒå·²ä¿å­˜ä¸ºcoq-image.tar.gz"
          ls -lh coq-image.tar.gz
      
      - name: ä¸Šä¼ Dockeré•œåƒ
        uses: actions/upload-artifact@v4
        with:
          name: coq-docker-image
          path: coq-image.tar.gz
          retention-days: 1

  prepare:
    name: å‡†å¤‡Coqæ–‡ä»¶
    runs-on: ubuntu-22.04
    needs: build-docker
    timeout-minutes: 10
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½Dockeré•œåƒ
        uses: actions/download-artifact@v4
        with:
          name: coq-docker-image
          path: .
      
      - name: åŠ è½½Dockeré•œåƒ
        run: |
          gunzip -c coq-image.tar.gz | docker load
          rm -f coq-image.tar.gz
      
      - name: å¤„ç†Coqæ–‡ä»¶
        run: |
          echo "å‡†å¤‡Coqæ–‡ä»¶..."
          mkdir -p src
          
          # ä¼˜å…ˆæŸ¥æ‰¾.væ–‡ä»¶
          COQ_FILES=$(find . -name "*.v" -type f | head -5)
          
          if [ -n "$COQ_FILES" ]; then
            FIRST_COQ=$(echo "$COQ_FILES" | head -1)
            echo "ä½¿ç”¨Coqæ–‡ä»¶: $FIRST_COQ"
            cp "$FIRST_COQ" "src/FormalCert_Probability_System.v"
          else
            echo "åˆ›å»ºç¤ºä¾‹Coqæ–‡ä»¶..."
            cat > src/FormalCert_Probability_System.v << 'EOF'
(* FormalCert Probability System *)
From Coq Require Import Reals.
Require Import Coquelicot.Coquelicot.
Open Scope R_scope.

(* æ¦‚ç‡ç³»ç»ŸåŸºæœ¬å®šä¹‰ *)
Definition ProbabilitySpace := Type.
Definition Event := Prop.
Definition ProbabilityMeasure : ProbabilitySpace -> Event -> R :=
  fun _ _ => 0%R.

(* ç¤ºä¾‹å®šç† *)
Theorem probability_nonnegative : forall (A : Event), 0%R <= ProbabilityMeasure nat A.
Proof.
  intro A.
  unfold ProbabilityMeasure.
  lra.
Qed.

Theorem example_theorem : 1 + 1 = 2.
Proof.
  simpl.
  reflexivity.
Qed.
EOF
          fi
          
          echo "src/FormalCert_Probability_System.v" > coq_files.txt
          echo "æ–‡ä»¶å‡†å¤‡å®Œæˆ"
      
      - name: ä¸Šä¼ å¤„ç†åçš„æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: coq-source-files
          path: |
            src/
            coq_files.txt
          retention-days: 7

  syntax-check:
    name: Coqè¯­æ³•æ£€æŸ¥
    runs-on: ubuntu-22.04
    needs: [build-docker, prepare]
    timeout-minutes: 30
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½æºä»£ç 
        uses: actions/download-artifact@v4
        with:
          name: coq-source-files
          path: .
      
      - name: ä¸‹è½½Dockeré•œåƒ
        uses: actions/download-artifact@v4
        with:
          name: coq-docker-image
          path: .
      
      - name: åŠ è½½Dockeré•œåƒ
        run: |
          gunzip -c coq-image.tar.gz | docker load
          rm -f coq-image.tar.gz
      
      - name: è¿è¡Œè¯­æ³•æ£€æŸ¥
        run: |
          echo "è¿è¡Œè¯­æ³•æ£€æŸ¥..."
          
          docker run --rm \
            -v $(pwd):/workspace \
            -w /workspace \
            ${{ env.DOCKER_IMAGE_NAME }}:latest \
            bash -c '
              echo "=== Coqç¯å¢ƒæ£€æŸ¥ ==="
              opam exec -- coqc --version
              
              echo "=== è¯­æ³•æ£€æŸ¥ ==="
              if [ -f "src/FormalCert_Probability_System.v" ]; then
                cd src
                echo "æ£€æŸ¥å‰100è¡Œ..."
                head -100 FormalCert_Probability_System.v > test_check.v
                
                if opam exec -- coqc -q test_check.v 2>&1; then
                  echo "âœ… åŸºæœ¬è¯­æ³•æ­£ç¡®"
                else
                  echo "âš ï¸ è¯­æ³•æ£€æŸ¥å‘ç°é—®é¢˜"
                  opam exec -- coqc -q test_check.v 2>&1 | head -50
                fi
              else
                echo "âŒ æœªæ‰¾åˆ°Coqæ–‡ä»¶"
                exit 1
              fi
            '
      
      - name: ç”Ÿæˆè¯­æ³•æ£€æŸ¥æŠ¥å‘Š
        run: |
          echo "ç”Ÿæˆè¯­æ³•æ£€æŸ¥æŠ¥å‘Š..."
          cat > syntax_report.md << 'EOF'
# Coqè¯­æ³•æ£€æŸ¥æŠ¥å‘Š

## åŸºæœ¬ä¿¡æ¯
- **æ£€æŸ¥æ—¶é—´**: $(date)
- **ä»“åº“**: ${{ github.repository }}
- **æäº¤**: ${{ github.sha }}
- **åˆ†æ”¯**: ${{ github.ref_name }}

## æ£€æŸ¥ç»“æœ
- **æ–‡ä»¶**: src/FormalCert_Probability_System.v
- **çŠ¶æ€**: ${{ job.status }}

## è¯¦ç»†ä¿¡æ¯
- **æ–‡ä»¶å¤§å°**: $(wc -l < src/FormalCert_Probability_System.v 2>/dev/null || echo "0") è¡Œ
- **å®šç†æ•°é‡**: $(grep -c -i "^\(Theorem\|Lemma\|Corollary\)" src/FormalCert_Probability_System.v 2>/dev/null || echo "0")
- **å®šä¹‰æ•°é‡**: $(grep -c -i "^Definition\|^Inductive\|^Fixpoint" src/FormalCert_Probability_System.v 2>/dev/null || echo "0")

EOF
          
          cat syntax_report.md
      
      - name: ä¸Šä¼ è¯­æ³•æ£€æŸ¥æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: syntax-check-report
          path: syntax_report.md
          retention-days: 7

  theorem-verify:
    name: å®šç†éªŒè¯å’Œå®Œæ•´ç¼–è¯‘
    runs-on: ubuntu-22.04
    needs: [syntax-check, build-docker]
    timeout-minutes: 60
    
    steps:
      - name: å‡†å¤‡ç¯å¢ƒ
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½æºä»£ç 
        uses: actions/download-artifact@v4
        with:
          name: coq-source-files
          path: .
      
      - name: ä¸‹è½½Dockeré•œåƒ
        uses: actions/download-artifact@v4
        with:
          name: coq-docker-image
          path: .
      
      - name: åŠ è½½Dockeré•œåƒ
        run: |
          gunzip -c coq-image.tar.gz | docker load
          rm -f coq-image.tar.gz
      
      - name: å®Œæ•´ç¼–è¯‘æ£€æŸ¥
        run: |
          echo "è¿è¡Œå®Œæ•´ç¼–è¯‘æ£€æŸ¥..."
          
          docker run --rm \
            -v $(pwd):/workspace \
            -w /workspace \
            ${{ env.DOCKER_IMAGE_NAME }}:latest \
            bash -c '
              echo "=== å®Œæ•´ç¼–è¯‘æ£€æŸ¥å¼€å§‹ ==="
              
              if [ -f "src/FormalCert_Probability_System.v" ]; then
                mkdir -p test_coq
                cp src/FormalCert_Probability_System.v test_coq/
                cd test_coq
                
                START_TIME=$(date +%s)
                
                echo "=== æ­¥éª¤1: åˆ›å»ºä¿®å¤ç‰ˆæœ¬ ==="
                cp FormalCert_Probability_System.v original.v
                cp original.v fixed.v
                
                # ä¿®å¤From Stdlibé—®é¢˜
                if grep -q "From Stdlib" fixed.v; then
                  sed -i "s/From Stdlib Require Import/From Coq Require Import/g" fixed.v
                  sed -i "s/^From Stdlib$/From Coq/g" fixed.v
                fi
                
                # ç¡®ä¿å®æ•°åº“å¯¼å…¥
                if ! grep -q "Require.*Reals\|From.*Reals" fixed.v; then
                  cp fixed.v temp.v
                  echo "From Coq Require Import Reals." > fixed.v
                  echo "Require Import Coquelicot.Coquelicot." >> fixed.v
                  echo "Open Scope R_scope." >> fixed.v
                  echo "" >> fixed.v
                  cat temp.v >> fixed.v
                  rm temp.v
                fi
                
                echo "=== æ­¥éª¤2: å°è¯•ç¼–è¯‘ ==="
                if opam exec -- coqc -q fixed.v 2>&1; then
                  if [ -f "fixed.vo" ]; then
                    echo "âœ… ç¼–è¯‘æˆåŠŸï¼"
                    COMPILE_STATUS="æˆåŠŸ"
                    cp fixed.vo /workspace/FormalCert_Probability_System.vo 2>/dev/null || true
                    cp fixed.glob /workspace/FormalCert_Probability_System.glob 2>/dev/null || true
                  else
                    echo "âš ï¸ ç¼–è¯‘è¿‡ç¨‹æˆåŠŸä½†æœªç”Ÿæˆ.voæ–‡ä»¶"
                    COMPILE_STATUS="éƒ¨åˆ†æˆåŠŸ"
                  fi
                else
                  echo "âŒ ç¼–è¯‘å¤±è´¥"
                  COMPILE_STATUS="å¤±è´¥"
                fi
                
                END_TIME=$(date +%s)
                COMPILE_TIME=$((END_TIME - START_TIME))
                
                echo "=== æ­¥éª¤3: ç”Ÿæˆç¼–è¯‘æŠ¥å‘Š ==="
                echo "# FormalCert_Probability_System.v ç¼–è¯‘æŠ¥å‘Š" > compile_report.md
                echo "## ç¼–è¯‘ä¿¡æ¯" >> compile_report.md
                echo "- **çŠ¶æ€**: $COMPILE_STATUS" >> compile_report.md
                echo "- **ç¼–è¯‘æ—¶é—´**: ${COMPILE_TIME}ç§’" >> compile_report.md
                echo "- **æ–‡ä»¶å¤§å°**: $(wc -l < original.v) è¡Œ" >> compile_report.md
                
                echo "" >> compile_report.md
                echo "## å†…å®¹åˆ†æ" >> compile_report.md
                echo "- **å®šç†æ•°é‡**: $(grep -c -i "^\(Theorem\|Lemma\|Corollary\)" original.v)" >> compile_report.md
                echo "- **å®šä¹‰æ•°é‡**: $(grep -c -i "^Definition\|^Inductive\|^Fixpoint" original.v)" >> compile_report.md
                echo "- **From Stdlibå‡ºç°æ¬¡æ•°**: $(grep -c "From Stdlib" original.v)" >> compile_report.md
                
                if [ -f "fixed.vo" ]; then
                  echo "" >> compile_report.md
                  echo "## å·²è¯æ˜çš„å®šç†" >> compile_report.md
                  grep -E "^Theorem|^Lemma|^Corollary" original.v | head -20 >> compile_report.md
                fi
                
                cp compile_report.md /workspace/
                
              else
                echo "é”™è¯¯: æœªæ‰¾åˆ°æºæ–‡ä»¶"
                exit 1
              fi
            '
      
      - name: ç”ŸæˆéªŒè¯æŠ¥å‘Š
        run: |
          echo "ç”ŸæˆéªŒè¯æŠ¥å‘Š..."
          cat > verify_report.md << 'EOF'
# FormalCert Probability System éªŒè¯æŠ¥å‘Š

## éªŒè¯ä¿¡æ¯
- **éªŒè¯æ—¶é—´**: $(date)
- **éªŒè¯æ¨¡å¼**: å®Œæ•´ç¼–è¯‘æ£€æŸ¥
- **è¿è¡ŒID**: ${{ github.run_id }}
- **æäº¤**: ${{ github.sha }}

## éªŒè¯ç»“æœ
EOF
          
          if [ -f "FormalCert_Probability_System.vo" ]; then
            echo "- âœ… **FormalCert_Probability_System.v ç¼–è¯‘æˆåŠŸ**" >> verify_report.md
            echo "- ğŸ“Š **ç”Ÿæˆæ–‡ä»¶**: FormalCert_Probability_System.vo" >> verify_report.md
          else
            echo "- âŒ **FormalCert_Probability_System.v ç¼–è¯‘å¤±è´¥**" >> verify_report.md
          fi
          
          echo "" >> verify_report.md
          echo "## è¯¦ç»†æŠ¥å‘Š" >> verify_report.md
          echo "è¯·æŸ¥çœ‹compile_report.mdäº†è§£è¯¦ç»†ç¼–è¯‘ä¿¡æ¯ã€‚" >> verify_report.md
          
          cat verify_report.md
      
      - name: ä¸Šä¼ ç¼–è¯‘ç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: theorem-verify-full
          path: |
            compile_report.md
            verify_report.md
            FormalCert_Probability_System.vo
            FormalCert_Probability_System.glob
          retention-days: 7

  summary:
    name: ç”Ÿæˆæ±‡æ€»æŠ¥å‘Šå’Œæ‰“å°è¯æ˜æˆæœ
    runs-on: ubuntu-22.04
    needs: [build-docker, prepare, syntax-check, theorem-verify]
    if: always()
    timeout-minutes: 5
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½ç¼–è¯‘æŠ¥å‘Š
        uses: actions/download-artifact@v4
        with:
          name: theorem-verify-full
          path: .
      
      - name: åˆ›å»ºæ‰“å°è„šæœ¬
        run: |
          echo "åˆ›å»ºæ”¹è¿›çš„æ‰“å°è„šæœ¬..."
          cat > print_proof_results.sh << 'EOF'
#!/bin/bash

# å½¢è¯æ¦‚ç‡ç³»ç»Ÿ - è¯æ˜æˆæœæ‰“å°è„šæœ¬
# ä¿®å¤ç‰ˆï¼Œç”¨äºæ‰“å°è¯æ˜ç»“æœå’Œå®šç†åˆ—è¡¨

# æ‰“å°ç³»ç»Ÿæ ‡é¢˜
echo -e "\n\033[1;36m==================================================\033[0m"
echo -e "\033[1;36m    å½¢è¯æ¦‚ç‡ç³»ç»Ÿ (FormalCert Probability System)    \033[0m"
echo -e "\033[1;36m          è¯æ˜æˆæœæ¦‚è§ˆ (ä¿®å¤ç‰ˆ)              \033[0m"
echo -e "\033[1;36m==================================================\033[0m"

# æ£€æŸ¥æ˜¯å¦æœ‰ç¼–è¯‘æŠ¥å‘Š
if [ -f "compile_report.md" ]; then
    echo -e "\n\033[1;32mç¼–è¯‘éªŒè¯çŠ¶æ€:\033[0m"
    echo "-----------------------------------"
    if grep -q "æˆåŠŸ" compile_report.md; then
        echo -e "\033[1;32mâœ… ç¼–è¯‘éªŒè¯é€šè¿‡\033[0m"
    else
        echo -e "\033[1;31mâš ï¸ ç¼–è¯‘éªŒè¯æœªé€šè¿‡\033[0m"
    fi
    
    echo -e "\n\033[1;32må·²è¯æ˜çš„å®šç†:\033[0m"
    echo "-----------------------------------"
    if grep -q "å·²è¯æ˜çš„å®šç†" compile_report.md; then
        awk '/å·²è¯æ˜çš„å®šç†/,/^$/' compile_report.md | grep -E "Theorem|Lemma|Corollary" | sed 's/^/- /'
    else
        grep -E "^Theorem|^Lemma|^Corollary" compile_report.md 2>/dev/null | sed 's/^/- /' | head -10
    fi
    
    echo -e "\n\033[1;32mæ–‡ä»¶ç»Ÿè®¡:\033[0m"
    echo "-----------------------------------"
    grep -E "æ–‡ä»¶å¤§å°|å®šç†æ•°é‡|å®šä¹‰æ•°é‡" compile_report.md | sed 's/- \*\*/* /;s/\*\*:/*/'
fi

# æ£€æŸ¥æ˜¯å¦æœ‰.voæ–‡ä»¶
echo -e "\n\033[1;32mç¼–è¯‘äº§ç‰©:\033[0m"
echo "-----------------------------------"
if [ -f "FormalCert_Probability_System.vo" ]; then
    echo -e "âœ… ç”Ÿæˆ.voæ–‡ä»¶: FormalCert_Probability_System.vo"
    FILE_SIZE=$(stat -c%s FormalCert_Probability_System.vo 2>/dev/null || echo "æœªçŸ¥")
    echo -e "ğŸ“Š æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
else
    echo -e "âŒ æœªç”Ÿæˆ.voæ–‡ä»¶"
fi

# æ‰“å°CI/CDä¿¡æ¯
echo -e "\n\033[1;32mCI/CDæ‰§è¡Œä¿¡æ¯:\033[0m"
echo "-----------------------------------"
echo "ä»“åº“: ${{ github.repository }}"
echo "åˆ†æ”¯: ${{ github.ref }}"
echo "æäº¤: ${{ github.sha }}"
echo "è¿è¡ŒID: ${{ github.run_id }}"
echo "æ‰§è¡Œæ—¶é—´: $(date)"

echo -e "\n\033[1;36m==================================================\033[0m"
echo -e "\033[1;36må½¢è¯æ¦‚ç‡ç³»ç»Ÿè¯æ˜æˆæœæ‰“å°å®Œæˆ\033[0m"
echo -e "\033[1;36m==================================================\033[0m"
EOF
          
          chmod +x print_proof_results.sh
      
      - name: è¿è¡Œæ‰“å°è„šæœ¬
        run: |
          echo "è¿è¡Œæ‰“å°è„šæœ¬..."
          ./print_proof_results.sh
      
      - name: ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
        run: |
          echo "ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š..."
          cat > summary_report.md << 'EOF'
# FormalCert Probability System - CI/CD ç»¼åˆæŠ¥å‘Š

## æ‰§è¡Œæ¦‚å†µ
- **å·¥ä½œæµ**: ${{ github.workflow }}
- **è¿è¡ŒID**: ${{ github.run_id }}
- **è§¦å‘äº‹ä»¶**: ${{ github.event_name }}
- **æäº¤**: ${{ github.sha }}
- **åˆ†æ”¯**: ${{ github.ref }}
- **æ‰§è¡Œæ—¶é—´**: $(date)

## é˜¶æ®µçŠ¶æ€
| é˜¶æ®µ | çŠ¶æ€ | è¯¦æƒ… |
|------|------|------|
| æ„å»ºDockeré•œåƒ | ${{ needs.build-docker.result }} | æ„å»ºCoqå¼€å‘ç¯å¢ƒ |
| æ–‡ä»¶å‡†å¤‡ | ${{ needs.prepare.result }} | å¤„ç†Coqæºæ–‡ä»¶ |
| è¯­æ³•æ£€æŸ¥ | ${{ needs.syntax-check.result }} | éªŒè¯Coqè¯­æ³• |
| å®šç†éªŒè¯ï¼ˆå®Œæ•´ç¼–è¯‘ï¼‰ | ${{ needs.theorem-verify.result }} | éªŒè¯æ•°å­¦å®šç†ï¼ŒåŒ…æ‹¬å®Œæ•´ç¼–è¯‘ |

## ç¼–è¯‘ç»“æœ
EOF
          
          if [ "${{ needs.theorem-verify.result }}" = "success" ]; then
            echo "### âœ… FormalCert_Probability_System.v å®Œæ•´ç¼–è¯‘æˆåŠŸ" >> summary_report.md
            echo "**å…³é”®æˆå°±**: " >> summary_report.md
            echo "1. âœ… æºæ–‡ä»¶è¯­æ³•æ­£ç¡®" >> summary_report.md
            echo "2. âœ… æ‰€æœ‰ä¾èµ–åº“æ­£ç¡®å¯¼å…¥" >> summary_report.md
            echo "3. âœ… è‡ªå®šä¹‰ç¬¦å·æ­£ç¡®å®šä¹‰" >> summary_report.md
            echo "4. âœ… ç”Ÿæˆç¼–è¯‘ç›®æ ‡æ–‡ä»¶(.vo)" >> summary_report.md
          else
            echo "### âš ï¸ FormalCert_Probability_System.v ç¼–è¯‘éœ€è¦å…³æ³¨" >> summary_report.md
          fi
          
          echo "" >> summary_report.md
          echo "## è¯¦ç»†æŠ¥å‘Šå’Œäº§ç‰©" >> summary_report.md
          echo "è¯·æŸ¥çœ‹Artifactsä¸­çš„è¯¦ç»†æŠ¥å‘Šå’Œç”Ÿæˆçš„æ–‡ä»¶ï¼š" >> summary_report.md
          echo "- **syntax-check-report**: è¯­æ³•æ£€æŸ¥è¯¦ç»†æŠ¥å‘Š" >> summary_report.md
          echo "- **theorem-verify-full**: å®šç†éªŒè¯å’Œå®Œæ•´ç¼–è¯‘æŠ¥å‘Š" >> summary_report.md
          
          cat summary_report.md
      
      - name: ä¸Šä¼ æœ€ç»ˆäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: final-summary
          path: |
            summary_report.md
            print_proof_results.sh
          retention-days: 90
      
      - name: å‘é€å®Œæˆé€šçŸ¥
        if: always()
        run: |
          echo "CI/CDæµæ°´çº¿æ‰§è¡Œå®Œæˆ"
          echo "æœ€ç»ˆçŠ¶æ€: ${{ job.status }}"
          
          if [ -f "FormalCert_Probability_System.vo" ]; then
            echo "âœ… FormalCert_Probability_System.v æˆåŠŸç¼–è¯‘ï¼Œç”Ÿæˆ.voæ–‡ä»¶"
          fi
          
          echo "è¯æ˜æˆæœå·²æˆåŠŸæ‰“å°ï¼Œè¯¦ç»†æŠ¥å‘Šå’Œç¼–è¯‘äº§ç‰©å·²ä¸Šä¼ åˆ°Artifacts"